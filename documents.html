<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documents - Therapy Docs</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Critical CSS to prevent FOUC -->
    <style>[x-cloak] { display: none !important; }</style>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">
  
    <!-- Tailwind CSS - Use dist/output.css after building -->
    <link rel="stylesheet" href="dist/output.css">
  
    <!-- Application Entry Point (ES Module) - includes Alpine.js -->
    <script type="module" src="js/entries/documents.entry.js"></script>
</head>
<body>
    <div x-data="app" @keydown.window.ctrl.shift.a.prevent="openAdminPanel" :class="{ 'mock-watermark': window.config?.useMockAPI }">

        <!-- Shared Navigation Drawer -->
            <div id="nav-drawer"></div>

            <!-- Header (View-Conditional) -->
            <header class="bg-white shadow-sm border-b border-neutral-200 sticky top-0 z-40">
                <div class="max-w-full px-4">
                    <div class="py-3 flex items-center gap-3">
                        <!-- Hamburger Menu (client-select view only) -->
                        <button x-show="entryView === 'client-select'" @click="drawerOpen = true" class="hamburger-btn">
                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#menu-hamburger"></use></svg>
                        </button>

                        <!-- Back Button (form-select and workspace views) -->
                        <button x-show="entryView !== 'client-select'" x-cloak @click="handleBackButton()" class="hamburger-btn">
                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#back"></use></svg>
                        </button>

                        <!-- Title: Documents (client-select view) -->
                        <h1 x-show="entryView === 'client-select'" class="text-lg font-bold text-neutral-900 flex items-center">
                            <svg class="icon mr-2 text-primary-500"><use href="./assets/icons/tabler-sprites.svg#documents-general"></use></svg>
                            Documents
                        </h1>

                        <!-- Title: Select Document Type (form-select view) -->
                        <h1 x-show="entryView === 'form-select'" x-cloak class="text-lg font-bold text-neutral-900">
                            Select Document Type
                        </h1>

                        <!-- Title: Form Type Name (workspace view) -->
                        <h1 x-show="entryView === 'workspace'" x-cloak class="text-lg font-bold text-neutral-900" x-text="formType"></h1>

                        <!-- Draft Status (workspace view only) -->
                        <div x-show="entryView === 'workspace'" x-cloak class="flex items-center gap-3 ml-auto">
                            <div class="hidden sm:flex items-center text-xs">
                                <span
                                    x-show="draftStatus === 'saving'"
                                    class="text-neutral-400 flex items-center"
                                >
                                    <blob-spinner class="icon-sm mr-1"></blob-spinner>
                                    <span class="hidden md:inline">Saving...</span>
                                </span>
                                <span
                                    x-show="draftStatus === 'saved'"
                                    x-transition
                                    class="text-success-600 flex items-center"
                                    title="Draft saved"
                                >
                                    <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#draft-saved"></use></svg>
                                    <span class="hidden md:inline">Saved</span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Client Context Strip (workspace view only) -->
                <div x-show="entryView === 'workspace' && selectedClient" x-cloak class="client-context-strip">
                    <div class="avatar" x-text="getClientInitials(selectedClient)"></div>
                    <span class="font-semibold text-neutral-900" x-text="getClientName(selectedClient)"></span>
                    <span class="text-neutral-400">|</span>
                    <span class="context-chip" x-text="clientContext.diagnosis?.icd10Code || 'No Dx'"></span>
                    <span
                        x-show="clientContext.treatmentPlan?.goals?.length"
                        class="context-chip goals"
                    >
                        <svg class="icon icon-xs mr-1"><use href="./assets/icons/tabler-sprites.svg#treatment-plan"></use></svg>
                        <span x-text="(clientContext.treatmentPlan?.goals?.length || 0) + ' goals'"></span>
                    </span>
                    <span class="text-neutral-500 text-xs ml-auto hidden sm:inline">
                        <span class="flex items-center justify-center">
                            <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#date"></use></svg>
                            <span x-text="clientContext.lastSession ? 'Last: ' + formatDate(clientContext.lastSession.date) : 'No sessions'"></span>
                        </span>
                    </span>
                    <button
                        @click="showClientDetails = true"
                        class="btn btn-secondary btn-sm"
                        type="button"
                    >
                        <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#show-options-from-right"></use></svg>
                        <span class="hidden sm:inline">Client Info</span>
                    </button>
                </div>
            </header>

            <!-- Client Context Slide-Out Overlay -->
            <div
                x-cloak
                class="slideout-overlay"
                :class="{ 'open': showClientDetails }"
                @click="showClientDetails = false"
                x-show="entryView === 'workspace'"
            ></div>

            <!-- Client Context Slide-Out Panel -->
            <div
                x-cloak
                class="slideout-panel"
                :class="{ 'open': showClientDetails }"
                x-show="entryView === 'workspace'"
                @keydown.escape="showClientDetails = false"
            >
                <!-- Panel Header -->
                <div class="slideout-panel-header">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-primary-200 flex items-center justify-center">
                            <span class="font-bold text-primary-700" x-text="getClientInitials(selectedClient)"></span>
                        </div>
                        <div>
                            <h2 class="font-bold text-neutral-900" x-text="getClientName(selectedClient)"></h2>
                            <p class="text-xs text-neutral-500" x-text="clientType || 'Individual'"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <!-- Cache age indicator -->
                        <template x-if="clientContextCacheAge !== null">
                            <div class="flex items-center gap-2 text-xs text-neutral-400">
                                <span x-text="clientContextCacheAge + 'm ago'"></span>
                                <button
                                    @click="refreshClientContext()"
                                    type="button"
                                    class="btn btn-ghost btn-sm p-1"
                                    title="Refresh client data"
                                >
                                    <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-restore"></use></svg>
                                </button>
                            </div>
                        </template>
                        <button @click="showClientDetails = false" class="text-neutral-400 hover:text-neutral-600 p-2 -mr-2">
                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                        </button>
                    </div>
                </div>

                <!-- Previous Session Section -->
                <div class="panel-section highlighted">
                    <div class="panel-section-title">
                        <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#history-recent"></use></svg>
                        <span x-text="clientContext.lastSession ? 'Previous Session - ' + formatDate(clientContext.lastSession.date) : 'Previous Session'"></span>
                    </div>
                    <div x-show="clientContext.lastSession">
                        <p class="text-sm text-neutral-700 leading-relaxed" x-text="clientContext.lastSession?.narrative"></p>
                        <!-- Edit Previous Session Button -->
                        <div class="mt-3 pt-3 border-t border-neutral-200">
                            <button
                                type="button"
                                @click="lastSessionDocument && loadDocumentForEditing(lastSessionDocument)"
                                :disabled="!lastSessionDocument"
                                class="btn btn-secondary btn-sm w-full"
                                :class="{ 'opacity-50 cursor-not-allowed': !lastSessionDocument }"
                            >
                                <span class="flex items-center justify-center">
                                    <svg class="icon icon-sm mr-1.5">
                                        <use :href="`./assets/icons/tabler-sprites.svg#${progressNoteEditMode === 'amendment-required' ? 'action-amend-document' : 'action-edit-document'}`"></use>
                                    </svg>
                                    <span x-text="progressNoteEditMode === 'amendment-required' ? 'Amend This Note' : 'Edit This Note'"></span>
                                </span>
                            </button>
                        </div>
                    </div>
                    <div x-show="!clientContext.lastSession" class="text-sm text-neutral-500 italic">
                        This is the client's first session.
                    </div>
                </div>

                <!-- Diagnosis Section -->
                <div class="panel-section">
                    <div class="panel-section-title">
                        <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#diagnosis"></use></svg>
                        <span>Diagnosis</span>
                    </div>
                    <div x-show="clientContext.diagnosis">
                        <div class="flex items-center flex-wrap gap-2 mb-2">
                            <span class="font-mono text-sm font-semibold text-primary-600" x-text="clientContext.diagnosis?.icd10Code"></span>
                            <span
                                x-show="clientContext.diagnosis?.status"
                                class="px-2 py-0.5 text-xs font-medium rounded-full"
                                :class="{
                                    'bg-warning-100 text-warning-700': clientContext.diagnosis?.status === 'provisional',
                                    'bg-success-100 text-success-700': clientContext.diagnosis?.status === 'active'
                                }"
                                x-text="clientContext.diagnosis?.status"
                            ></span>
                            <span
                                x-show="clientContext.diagnosis?.severity"
                                class="px-2 py-0.5 text-xs font-medium rounded-full bg-neutral-100 text-neutral-600"
                                x-text="clientContext.diagnosis?.severity"
                            ></span>
                        </div>
                        <p class="text-sm text-neutral-700 mb-1" x-text="clientContext.diagnosis?.description"></p>
                        <p class="text-xs text-neutral-500">
                            <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#date"></use></svg>
                            Diagnosed: <span x-text="formatDate(clientContext.diagnosis?.dateOfDiagnosis)"></span>
                        </p>
                    </div>
                    <div x-show="!clientContext.diagnosis" class="text-sm text-neutral-500 italic">
                        No diagnosis on file.
                    </div>
                </div>

                <!-- Treatment Plan Section -->
                <div class="panel-section">
                    <div class="panel-section-title">
                        <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#treatment-plan"></use></svg>
                        <span>Treatment Plan</span>
                    </div>
                    <div x-show="clientContext.treatmentPlan">
                        <!-- Goals -->
                        <div x-show="clientContext.treatmentPlan?.goals?.length" class="mb-3">
                            <p class="text-xs font-medium text-neutral-500 mb-1">Goals:</p>
                            <ul class="text-sm text-neutral-700 space-y-1">
                                <template x-for="(goal, index) in (clientContext.treatmentPlan?.goals || [])" :key="index">
                                    <li class="flex items-start gap-2">
                                        <svg class="icon icon-xs text-neutral-300 mt-1.5"><use href="./assets/icons/tabler-sprites.svg#bullet-small"></use></svg>
                                        <span x-text="goal"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>

                        <!-- Interventions -->
                        <div x-show="clientContext.treatmentPlan?.interventions?.length" class="mb-3">
                            <p class="text-xs font-medium text-neutral-500 mb-1">Interventions:</p>
                            <p class="text-sm text-neutral-700" x-text="(clientContext.treatmentPlan?.interventions || []).join(', ')"></p>
                        </div>

                        <!-- Target Symptoms -->
                        <div x-show="clientContext.treatmentPlan?.targetSymptoms?.length" class="mb-3">
                            <p class="text-xs font-medium text-neutral-500 mb-1">Target Symptoms:</p>
                            <div class="flex flex-wrap gap-1">
                                <template x-for="(symptom, index) in (clientContext.treatmentPlan?.targetSymptoms || [])" :key="index">
                                    <span class="px-2 py-0.5 text-xs rounded bg-neutral-100 text-neutral-600" x-text="symptom"></span>
                                </template>
                            </div>
                        </div>

                        <!-- Dates -->
                        <div class="pt-3 mt-3 border-t border-neutral-100">
                            <p class="text-xs text-neutral-500">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#date"></use></svg>
                                Created: <span x-text="formatDate(clientContext.treatmentPlan?.date)"></span>
                                <span x-show="clientContext.treatmentPlan?.reviewDate">
                                    &nbsp;|&nbsp; Review: <span x-text="formatDate(clientContext.treatmentPlan?.reviewDate)"></span>
                                </span>
                            </p>
                        </div>
                    </div>
                    <div x-show="!clientContext.treatmentPlan" class="text-sm text-neutral-500 italic">
                        No treatment plan on file.
                    </div>
                </div>

                <!-- Session History Section -->
                <div class="panel-section bg-neutral-50">
                    <div class="panel-section-title">
                        <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#session-history"></use></svg>
                        <span>Session History</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-neutral-500">Total Sessions</p>
                            <p class="font-semibold text-neutral-900" x-text="getSelectedClientSessionCount()"></p>
                        </div>
                        <div>
                            <p class="text-neutral-500">Client Type</p>
                            <p class="font-semibold text-neutral-900" x-text="clientType || 'Individual'"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Shared New Client Modal -->
            <div id="new-client-modal"></div>

            <!-- Draft Switch Modal (Save/Move/Discard on client change) -->
            <div id="draft-switch-modal"></div>

            <!-- Draft Selection Modal (Choose draft to continue) -->
            <div id="draft-selection-modal"></div>

            <!-- Client Confirmation Modal (Verify correct client before starting) -->
            <div x-cloak
                x-show="showClientConfirmModal && pendingClientConfirmation"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="modal-overlay"
                @click.self="cancelClientSelection()"
                @keydown.escape="cancelClientSelection()"
            >
                <div class="card w-full max-w-md bg-white">
                    <!-- Header -->
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                            <svg class="icon text-primary-600"><use href="./assets/icons/tabler-sprites.svg#client-response"></use></svg>
                        </div>
                        <h2 class="text-xl font-bold text-neutral-900">Start Session Note</h2>
                    </div>

                    <!-- Client Info -->
                    <div class="bg-neutral-50 rounded-lg p-4 mb-4 border border-neutral-200">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-12 h-12 rounded-full bg-primary-200 flex items-center justify-center">
                                <span class="text-lg font-bold text-primary-700"
                                    x-text="pendingClientConfirmation?.client?.initials || '?'"></span>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-neutral-900"
                                    x-text="pendingClientConfirmation?.client?.name"></h3>
                                <p class="text-sm text-neutral-500"
                                    x-text="pendingClientConfirmation?.client?.clientType || 'Individual'"></p>
                            </div>
                        </div>

                        <!-- Last Session Info -->
                        <div class="space-y-2 text-sm">
                            <template x-if="pendingClientConfirmation?.context?.lastSession">
                                <div class="flex items-center gap-2 text-neutral-600">
                                    <svg class="icon icon-sm text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#date-last-session"></use></svg>
                                    <span>Last session:
                                        <strong x-text="formatDate(pendingClientConfirmation.context.lastSession.date)"></strong>
                                    </span>
                                </div>
                            </template>
                            <template x-if="!pendingClientConfirmation?.context?.lastSession">
                                <div class="flex items-center gap-2 text-neutral-500 italic">
                                    <svg class="icon icon-sm text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#date-none"></use></svg>
                                    <span>No previous sessions</span>
                                </div>
                            </template>

                            <!-- Diagnosis Info -->
                            <template x-if="pendingClientConfirmation?.context?.diagnosis">
                                <div class="flex items-start gap-2 text-neutral-600">
                                    <svg class="icon icon-sm text-neutral-400 mt-0.5"><use href="./assets/icons/tabler-sprites.svg#diagnosis"></use></svg>
                                    <span>
                                        <strong x-text="pendingClientConfirmation.context.diagnosis.icd10Code"></strong>
                                        <span class="text-neutral-500" x-text="' - ' + pendingClientConfirmation.context.diagnosis.description"></span>
                                    </span>
                                </div>
                            </template>
                            <template x-if="!pendingClientConfirmation?.context?.diagnosis">
                                <div class="flex items-center gap-2 text-neutral-500 italic">
                                    <svg class="icon icon-sm text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#diagnosis"></use></svg>
                                    <span>No active diagnosis</span>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Confirmation Text -->
                    <p class="text-neutral-600 text-sm mb-4">
                        Is this the correct client for today's session?
                    </p>

                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button
                            type="button"
                            @click="cancelClientSelection()"
                            class="btn btn-secondary flex-1"
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            @click="confirmClientSelection()"
                            class="btn btn-primary flex-1"
                        >
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#action-start"></use></svg>
                            Start Note
                        </button>
                    </div>
                </div>
            </div>

            <!-- Duplicate/Conflict Warning Modal -->
            <div x-cloak
                x-show="showDuplicateModal"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="modal-overlay"
                @keydown.escape="dismissDuplicateModal()"
            >
                <div class="card w-full max-w-md bg-white">
                    <!-- Header -->
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-danger-100 flex items-center justify-center">
                            <svg class="icon text-danger-600"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                        </div>
                        <h2 class="text-xl font-bold text-neutral-900">Duplicate Warning</h2>
                    </div>

                    <!-- Warning Messages -->
                    <div class="space-y-3 mb-6">
                        <!-- Backend document exists -->
                        <template x-if="duplicateWarnings.hasBackendDocument">
                            <div class="flex items-start gap-3 p-3 bg-danger-50 rounded-lg border border-danger-200">
                                <svg class="icon text-danger-600 mt-0.5 shrink-0"><use href="./assets/icons/tabler-sprites.svg#warning-duplicate"></use></svg>
                                <div>
                                    <p class="font-medium text-danger-800">A progress note already exists for this date</p>
                                    <p class="text-sm text-danger-600 mt-1">
                                        A note was previously saved for <span x-text="DateUtils.formatDateOnly(currentNote.date)"></span>.
                                        Consider editing the existing note instead.
                                    </p>
                                </div>
                            </div>
                        </template>

                        <!-- Other draft exists -->
                        <template x-if="duplicateWarnings.hasOtherDraft">
                            <div class="flex items-start gap-3 p-3 bg-warning-50 rounded-lg border border-warning-200">
                                <svg class="icon text-warning-600 mt-0.5 shrink-0"><use href="./assets/icons/tabler-sprites.svg#draft-continue"></use></svg>
                                <div>
                                    <p class="font-medium text-warning-800">Another draft exists for this date</p>
                                    <p class="text-sm text-warning-600 mt-1">
                                        You have another unsaved draft for <span x-text="DateUtils.formatDateOnly(currentNote.date)"></span>.
                                        This may create duplicate notes.
                                    </p>
                                </div>
                            </div>
                        </template>

                        <!-- Date predates client creation -->
                        <template x-if="duplicateWarnings.predatesClient">
                            <div class="flex items-start gap-3 p-3 bg-danger-50 rounded-lg border border-danger-200">
                                <svg class="icon text-danger-600 mt-0.5 shrink-0"><use href="./assets/icons/tabler-sprites.svg#date-none"></use></svg>
                                <div>
                                    <p class="font-medium text-danger-800">Session date is before client was added</p>
                                    <p class="text-sm text-danger-600 mt-1">
                                        The selected date is earlier than when this client was created in the system.
                                        Please verify the date is correct.
                                    </p>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button
                            type="button"
                            @click="dismissDuplicateModal()"
                            class="btn btn-primary flex-1"
                        >
                            I Understand, Continue
                        </button>
                    </div>
                    <p class="text-xs text-neutral-500 mt-3 text-center">
                        You can still save this note. This warning is for your awareness.
                    </p>
                </div>
            </div>

            <!-- Amendment Reason Modal -->
            <div x-cloak
                x-show="showAmendmentReasonModal"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="modal-overlay"
                @keydown.escape="cancelAmendment()"
            >
                <div class="card w-full max-w-md bg-white">
                    <!-- Header -->
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-lg bg-primary-100 flex items-center justify-center">
                            <svg class="icon text-primary-600"><use href="./assets/icons/tabler-sprites.svg#action-amend-document"></use></svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-neutral-900">Create Amendment</h2>
                            <p class="text-sm text-neutral-500">A new document will be created linked to the original</p>
                        </div>
                    </div>

                    <!-- Amendment Info -->
                    <div class="bg-neutral-50 rounded-lg p-4 mb-4">
                        <p class="text-sm text-neutral-600">
                            <span class="font-medium">Original Note:</span>
                            <span x-text="documentBeingAmended ? DateUtils.formatDateOnly(documentBeingAmended.date) : ''"></span>
                        </p>
                        <p class="text-xs text-neutral-500 mt-2">
                            The original note will remain unchanged. Your changes will be saved as a new amendment document.
                        </p>
                    </div>

                    <!-- Reason Input -->
                    <div class="mb-6">
                        <label class="form-label">Reason for Amendment <span class="text-danger-500">*</span></label>
                        <textarea
                            x-model="amendmentReason"
                            class="form-textarea"
                            rows="3"
                            placeholder="e.g., Corrected medication name, Added missing information..."
                        ></textarea>
                        <p class="text-xs text-neutral-500 mt-1">
                            This reason will be recorded with the amendment for compliance purposes.
                        </p>
                    </div>

                    <!-- Actions -->
                    <div class="flex gap-3">
                        <button
                            type="button"
                            @click="cancelAmendment()"
                            class="btn btn-secondary flex-1"
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            @click="startAmendment()"
                            :disabled="!amendmentReason.trim()"
                            class="btn btn-primary flex-1"
                            :class="{ 'opacity-50 cursor-not-allowed': !amendmentReason.trim() }"
                        >
                            Start Amendment
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin Panel Modal (Admin+ only) -->
            <div x-cloak
                x-show="showAdminPanel && isAdmin"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="modal-overlay items-start overflow-y-auto py-8"
                @click.self="closeAdminPanel"
                @keydown.escape="closeAdminPanel"
            >

                <div class="card w-full max-w-[800px] bg-white h-[85vh] flex flex-col overflow-hidden">
                    <!-- Header -->
                    <div class="flex items-center justify-between px-6 pt-6 pb-4 mb-4 border-b border-neutral-200 shrink-0">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-secondary-100 flex items-center justify-center">
                                <svg class="icon text-secondary-600"><use href="./assets/icons/tabler-sprites.svg#admin-view"></use></svg>
                            </div>
                            <h2 class="text-2xl font-bold text-neutral-900">Admin Panel</h2>
                        </div>
                        <button @click="closeAdminPanel" class="modal-close-btn" type="button">
                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                        </button>
                    </div>

                    <!-- Scrollable Content -->
                    <div class="flex-1 overflow-y-auto px-6 pb-6" style="min-height: 0;">
                        <!-- Client List View -->
                        <div x-show="!confirmDeleteClientId">
                        <div class="bg-warning-50 border border-warning-200 rounded-lg p-4 mb-4 flex items-center gap-3">
                            <svg class="icon text-warning-600"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                            <p class="text-sm text-warning-900">
                                <strong>Warning:</strong> Deletion is permanent and removes all associated data (sessions, diagnoses, treatment plans).
                            </p>
                        </div>

                        <div class="space-y-3">
                            <template x-for="client in clients" :key="client.id">
                                <div class="flex items-center justify-between p-4 border border-neutral-200 rounded-lg bg-neutral-50 hover:bg-neutral-100 hover:border-neutral-300 transition-all duration-150 shadow-sm">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3 mb-2">
                                            <h3 class="text-lg font-semibold text-neutral-900" x-text="client.name"></h3>
                                            <span
                                                class="px-2 py-0.5 text-xs font-medium rounded-full bg-secondary-100 text-secondary-700"
                                                x-text="client.clientType"
                                            ></span>
                                        </div>
                                        <div class="flex items-center gap-4 text-sm text-neutral-600">
                                            <span class="flex items-center gap-1.5">
                                                <svg class="icon icon-sm text-neutral-500"><use href="./assets/icons/tabler-sprites.svg#sessions"></use></svg>
                                                <span>
                                                    <strong x-text="client.totalSessions"></strong>
                                                    <span x-text="client.totalSessions === 1 ? ' session' : ' sessions'"></span>
                                                </span>
                                            </span>
                                            <template x-if="client.lastSessionDate">
                                                <span class="flex items-center gap-1.5">
                                                    <svg class="icon icon-sm text-neutral-500"><use href="./assets/icons/tabler-sprites.svg#time-recent"></use></svg>
                                                    <span>
                                                        <span>Last session: </span>
                                                        <strong x-text="formatDate(client.lastSessionDate)"></strong>
                                                    </span>
                                                </span>
                                            </template>
                                        </div>
                                    </div>
                                    <button
                                        @click="confirmDeleteClient(client.id)"
                                        class="btn btn-danger btn-sm ml-6 shrink-0"
                                        type="button"
                                    >
                                        <svg class="icon icon-md mr-1"><use href="./assets/icons/tabler-sprites.svg#action-delete"></use></svg> Delete
                                    </button>
                                </div>
                            </template>

                            <div x-show="clients.length === 0" class="text-center py-8 text-neutral-500">
                                No clients found.
                            </div>
                        </div>
                        </div>

                        <!-- Delete Confirmation View -->
                        <div x-show="confirmDeleteClientId">
                        <div class="bg-danger-50 border border-danger-200 rounded p-4 mb-4">
                            <div class="flex items-start">
                                <svg class="icon text-danger-500 mt-1 mr-3"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                                <div>
                                    <h3 class="font-semibold text-danger-900 mb-1">Confirm Deletion</h3>
                                    <p class="text-sm text-danger-800">
                                        Are you sure you want to delete
                                        <strong x-text="clients.find(c => c.id === confirmDeleteClientId)?.name"></strong>?
                                    </p>
                                    <p class="text-sm text-danger-800 mt-2">
                                        This will permanently delete:
                                    </p>
                                    <ul class="text-sm text-danger-800 list-disc list-inside mt-1">
                                        <li>All session notes and AI summaries</li>
                                        <li>Diagnosis and treatment plan</li>
                                        <li>All client metadata</li>
                                    </ul>
                                    <p class="text-sm text-danger-900 font-medium mt-2">
                                        This action cannot be undone.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3">
                            <button
                                @click="cancelDelete"
                                class="btn btn-secondary flex-1"
                                type="button"
                                :disabled="deletingClientId"
                            >
                                Cancel
                            </button>
                            <button
                                @click="deleteClient(confirmDeleteClientId)"
                                class="btn btn-danger flex-1"
                                type="button"
                                :disabled="deletingClientId"
                            >
                                <span x-show="!deletingClientId" class="flex items-center justify-center">
                                    <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#action-delete"></use></svg> Delete Client
                                </span>
                                <span x-show="deletingClientId" class="flex items-center justify-center">
                                    <blob-spinner class="icon-sm mr-1"></blob-spinner> Deleting...
                                </span>
                            </button>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Exit Confirmation Modal (for leaving workspace with unsaved changes) -->
            <div
                x-show="showExitConfirmModal"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0"
                x-transition:enter-end="opacity-100"
                x-transition:leave="transition ease-in duration-150"
                x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="modal-overlay"
                @click.self="showExitConfirmModal = false"
                @keydown.escape="showExitConfirmModal = false"
                x-cloak
            >
                <div class="card w-full max-w-md">
                    <div class="card-body">
                        <div class="text-center mb-4">
                            <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-warning-100 text-warning-600 mb-3">
                                <svg class="icon icon-lg"><use href="./assets/icons/custom-sprites.svg#action-save"></use></svg>
                            </div>
                            <h2 class="text-xl font-semibold text-neutral-900">Save Your Work?</h2>
                        </div>

                        <p class="text-neutral-600 text-center mb-6">
                            You have unsaved changes to this <span x-text="formType.toLowerCase()"></span>.
                        </p>

                        <div class="flex flex-col gap-2">
                            <button
                                @click="saveAndExitWorkspace()"
                                class="btn btn-primary w-full"
                                type="button"
                            >
                                <svg class="icon mr-2"><use href="./assets/icons/custom-sprites.svg#action-save"></use></svg>
                                Save & Exit
                            </button>
                            <button
                                @click="discardAndExitWorkspace()"
                                class="btn btn-secondary w-full"
                                type="button"
                            >
                                Discard Changes
                            </button>
                            <button
                                @click="showExitConfirmModal = false"
                                class="btn btn-ghost w-full text-neutral-600"
                                type="button"
                            >
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <template x-if="loading">
                <div class="p-8 text-center">
                    <blob-spinner class="icon-lg mx-auto mb-4"></blob-spinner>
                    <p class="text-neutral-500">Loading...</p>
                </div>
            </template>

            <!-- ============================================ -->
            <!-- VIEW 1: CLIENT SELECTION                     -->
            <!-- ============================================ -->
            <template x-if="!loading && entryView === 'client-select'">
                <main class="max-w-2xl mx-auto px-4 mt-6 pt-6 pb-12 view-enter">
                    <!-- Question Header -->
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-neutral-900 mb-2">Who would you like to document for?</h2>
                        <p class="text-neutral-600">Select a client</p>
                    </div>

                    <!-- Search Bar -->
                    <div class="search-input-wrapper mb-6">
                        <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#search"></use></svg>
                        <input
                            type="text"
                            x-model="clientSearchQuery"
                            placeholder="Search clients..."
                            class="form-input w-full"
                        >
                    </div>

                    <!-- Today's Sessions (if any) -->
                    <div class="mb-6" x-show="todaysSessions.length > 0">
                        <h3 class="text-sm font-semibold text-neutral-600 uppercase tracking-wide mb-3 flex items-center gap-2">
                            <svg class="icon text-primary-500"><use href="./assets/icons/tabler-sprites.svg#date-today"></use></svg>
                            Today's Sessions
                        </h3>
                        <div class="space-y-2">
                            <template x-for="session in todaysSessions" :key="session.clientId">
                                <div class="client-card" @click="selectClientForEntry(session.clientId)">
                                    <div class="avatar" x-text="session.clientInitials"></div>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-0.5">
                                            <span class="font-semibold text-neutral-900" x-text="session.clientName"></span>
                                            <span class="badge badge-primary text-xs" x-text="formatTime(session.appointmentDatetime)"></span>
                                        </div>
                                        <p class="text-sm text-neutral-500" x-text="session.clientType"></p>
                                    </div>
                                    <svg class="icon text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#collapsed-indicator"></use></svg>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Just Added Clients (when not searching) -->
                    <div class="mb-6" x-show="clientSearchQuery.length === 0 && !showAllClients && justAddedClients.length > 0">
                        <h3 class="text-sm font-semibold text-neutral-600 uppercase tracking-wide mb-3 flex items-center gap-2">
                            <svg class="icon text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#status-new"></use></svg>
                            Just Added
                        </h3>
                        <div class="space-y-2">
                            <template x-for="client in justAddedClients" :key="client.id">
                                <div class="client-card" @click="selectClientForEntry(client.id)">
                                    <div class="avatar" x-text="client.initials || client.name.split(' ').map(n => n[0]).join('')"></div>
                                    <div class="flex-1 min-w-0">
                                        <span class="font-semibold text-neutral-900" x-text="client.name"></span>
                                        <p class="text-sm text-neutral-500" x-text="client.clientType || 'Individual'"></p>
                                    </div>
                                    <svg class="icon text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#collapsed-indicator"></use></svg>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Recent Clients (when not searching) -->
                    <div class="mb-6" x-show="clientSearchQuery.length === 0 && !showAllClients && recentClients.length > 0">
                        <h3 class="text-sm font-semibold text-neutral-600 uppercase tracking-wide mb-3 flex items-center gap-2">
                            <svg class="icon text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#history-recent"></use></svg>
                            Recent Clients
                        </h3>
                        <div class="space-y-2">
                            <template x-for="client in recentClients" :key="client.id">
                                <div class="client-card" @click="selectClientForEntry(client.id)">
                                    <div class="avatar" x-text="client.initials || client.name.split(' ').map(n => n[0]).join('')"></div>
                                    <div class="flex-1 min-w-0">
                                        <span class="font-semibold text-neutral-900" x-text="client.name"></span>
                                        <p class="text-sm text-neutral-500">
                                            <span x-text="client.clientType || 'Individual'"></span>
                                            <span class="mx-1"></span>
                                            <span x-text="'Last: ' + formatDate(client.lastSessionDate)"></span>
                                        </p>
                                    </div>
                                    <svg class="icon text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#collapsed-indicator"></use></svg>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- All/Filtered Clients -->
                    <div x-show="clientSearchQuery.length > 0 || showAllClients">
                        <h3 class="text-sm font-semibold text-neutral-600 uppercase tracking-wide mb-3">
                            <span x-text="clientSearchQuery.length > 0 ? 'Search Results' : 'All Active Clients'"></span>
                            <span x-show="clientSearchQuery.length > 0" class="text-neutral-400 font-normal ml-2" x-text="'(' + filteredClients.length + ')'"></span>
                        </h3>
                        <div class="space-y-2">
                            <template x-for="client in filteredClients" :key="client.id">
                                <div class="client-card" @click="selectClientForEntry(client.id)">
                                    <div class="avatar" x-text="client.initials || client.name.split(' ').map(n => n[0]).join('')"></div>
                                    <div class="flex-1 min-w-0">
                                        <span class="font-semibold text-neutral-900" x-text="client.name"></span>
                                        <p class="text-sm text-neutral-500" x-text="client.clientType || 'Individual'"></p>
                                    </div>
                                    <svg class="icon text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#collapsed-indicator"></use></svg>
                                </div>
                            </template>
                            <div x-show="filteredClients.length === 0" class="text-center py-8 text-neutral-500">
                                <svg class="icon icon-2xl mb-3 opacity-50"><use href="./assets/icons/tabler-sprites.svg#empty-no-results"></use></svg>
                                <p>No clients found matching "<span x-text="clientSearchQuery"></span>"</p>
                            </div>
                        </div>
                    </div>

                    <!-- Show All Toggle -->
                    <div x-show="clientSearchQuery.length === 0 && !showAllClients && clients.length > 0" class="text-center mt-6">
                        <button @click="showAllClients = true" class="btn btn-ghost text-neutral-600">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#clients"></use></svg>
                            Show All Clients (<span x-text="clients.length"></span>)
                        </button>
                    </div>

                    <!-- Show Less Toggle -->
                    <div x-show="clientSearchQuery.length === 0 && showAllClients" class="text-center mt-6">
                        <button @click="showAllClients = false" class="btn btn-ghost text-neutral-600">
                            Show Less
                        </button>
                    </div>

                    <!-- New Client FAB -->
                    <button
                        x-show="!isSupervisor && userRole !== 'sysadmin'"
                        @click="openNewClientModal()"
                        class="btn-fab fixed bottom-6 right-6"
                        type="button"
                        title="Add new client"
                    >
                        <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-add-client"></use></svg>
                    </button>
                </main>
            </template>

            <!-- ============================================ -->
            <!-- VIEW 2: FORM TYPE SELECTION                  -->
            <!-- ============================================ -->
            <template x-if="!loading && entryView === 'form-select'">
                <main class="max-w-2xl mx-auto px-4 mt-6 pt-6 pb-12 view-enter">
                    <!-- Selected Client Banner -->
                    <div class="selected-client-banner">
                        <div class="avatar" x-text="getClientInitials(selectedClient)"></div>
                        <div class="flex-1 min-w-0">
                            <span class="font-semibold text-primary-900" x-text="getClientName(selectedClient)"></span>
                            <span class="text-primary-700 text-sm ml-2" x-text="clientType || 'Individual'"></span>
                        </div>
                        <button @click="goBackFromFormSelect()" class="btn btn-ghost btn-sm text-primary-600" type="button">
                            Change
                        </button>
                    </div>

                    <!-- Question Header -->
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold text-neutral-900 mb-2">What type of document?</h2>
                        <p class="text-neutral-600">Choose the documentation you want to create or edit</p>
                    </div>

                    <!-- Loading State -->
                    <div x-show="loadingClientContext" class="text-center py-8 text-neutral-500">
                        <blob-spinner class="icon-lg mb-2"></blob-spinner>
                        <p>Loading client context...</p>
                    </div>

                    <!-- Form Type Cards -->
                    <div class="space-y-3" x-show="!loadingClientContext">
                        <template x-for="ft in formTypeOptions" :key="ft.id">
                            <div
                                class="form-type-card"
                                :class="{ 'recommended': ft.id === 'Progress Note' }"
                                @click="selectFormTypeAndEnter(ft.id)"
                            >
                                <div class="icon-box" :class="{ 'bg-primary-500 text-white': ft.id === 'Progress Note' }">
                                    <svg class="icon"><use :href="'./assets/icons/tabler-sprites.svg#' + ft.icon"></use></svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <div class="flex items-center gap-2 mb-1 flex-wrap">
                                        <span class="font-semibold text-neutral-900" x-text="ft.label"></span>
                                        <span x-show="ft.isBeta" class="badge badge-beta text-xs">Beta</span>
                                        <span x-show="ft.isNotImplemented" class="badge badge-not-implemented text-xs">Not implemented</span>
                                    </div>
                                    <p class="text-sm text-neutral-600" x-text="getFormTypeDescription(ft.id)"></p>
                                </div>
                                <svg class="icon text-neutral-400 shrink-0"><use href="./assets/icons/tabler-sprites.svg#collapsed-indicator"></use></svg>
                            </div>
                        </template>

                        <!-- Continue Drafts Section (if any) -->
                        <div class="!mt-10 pt-6 border-t border-neutral-200" x-show="clientDraftsForSelection.length > 0">
                            <h3 class="text-sm font-semibold text-neutral-600 uppercase tracking-wide mb-3 flex items-center gap-2">
                                <svg class="icon text-neutral-400"><use href="./assets/icons/custom-sprites.svg#action-save"></use></svg>
                                Continue Drafts
                            </h3>
                            <div class="space-y-2">
                                <template x-for="draft in clientDraftsForSelection" :key="draft.uuid">
                                    <div class="client-card" @click="formType = draft.formType; loadDraft(draft.uuid); entryView = 'workspace'">
                                        <div class="icon-box w-10 h-10 rounded-lg bg-neutral-100 flex items-center justify-center text-neutral-600">
                                            <svg class="icon"><use :href="'./assets/icons/tabler-sprites.svg#' + draft.formTypeIcon"></use></svg>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <span class="font-semibold text-neutral-900" x-text="draft.formTypeLabel"></span>
                                            <p class="text-sm text-neutral-500">
                                                Started <span x-text="formatDate(draft.sessionDate)"></span>
                                            </p>
                                        </div>
                                        <span class="badge badge-neutral text-xs">Draft</span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </main>
            </template>

            <!-- ============================================ -->
            <!-- VIEW 3: WORKSPACE                            -->
            <!-- ============================================ -->
            <template x-if="!loading && entryView === 'workspace'">
            <main class="container-narrow section view-enter">
                <div class="space-y-6">

                    <!-- Supervisor View-Only Banner -->
                    <div x-show="isSupervisor" class="alert-info">
                        <div class="flex items-center">
                            <svg class="icon mr-3"><use href="./assets/icons/tabler-sprites.svg#admin-view"></use></svg>
                            <div>
                                <p class="font-semibold">View-Only Access</p>
                                <p class="text-sm opacity-90">You can view client information and session notes, but editing is restricted.</p>
                            </div>
                        </div>
                    </div>

                    <!-- Form Type Placeholder (for non-implemented forms: Consultation, Discharge) -->
                    <div x-show="formType !== 'Progress Note' && formType !== 'Diagnosis' && formType !== 'Intake' && formType !== 'Treatment Plan'" class="card">
                        <div class="text-center py-8">
                            <svg class="icon icon-2xl text-neutral-300 mb-3"><use href="./assets/icons/tabler-sprites.svg#sessions"></use></svg>
                            <h3 class="text-lg font-semibold text-neutral-700 mb-2" x-text="formType"></h3>
                            <p class="text-sm text-neutral-500">This form type is coming soon.</p>
                        </div>
                    </div>

                    <!-- ========================================
                         DIAGNOSIS FORM
                         ======================================== -->
                    <div x-show="formType === 'Diagnosis'" x-init="$watch('formType', v => v === 'Diagnosis' && loadClientDiagnoses())" class="space-y-6">

                        <!-- No client selected -->
                        <div x-show="!selectedClient" class="card">
                            <div class="text-center py-8">
                                <svg class="icon icon-2xl text-neutral-300 mb-3"><use href="./assets/icons/tabler-sprites.svg#diagnosis"></use></svg>
                                <h3 class="text-lg font-semibold text-neutral-700 mb-2">Diagnosis Management</h3>
                                <p class="text-sm text-neutral-500">Select a client to view and manage their diagnoses.</p>
                            </div>
                        </div>

                        <!-- Loading state -->
                        <div x-show="selectedClient && loadingDiagnoses" class="card">
                            <div class="flex items-center justify-center py-8 text-neutral-600">
                                <blob-spinner class="mr-2"></blob-spinner>
                                <span>Loading diagnoses...</span>
                            </div>
                        </div>

                        <!-- Master-Detail Layout -->
                        <div x-show="selectedClient && !loadingDiagnoses" class="master-detail">

                            <!-- ========================================
                                 LEFT PANEL: DIAGNOSIS LIST
                                 ======================================== -->
                            <div class="list-panel">
                                <div class="list-panel-header">
                                    <h2 class="text-sm font-bold text-neutral-800">Diagnoses</h2>
                                </div>
                                <div class="list-panel-body">

                                    <!-- Current Diagnoses Section -->
                                    <div class="list-section-header">Current Diagnoses</div>

                                    <!-- Empty state for active diagnoses -->
                                    <div x-show="activeDiagnoses.length === 0" class="p-4 text-center text-neutral-500">
                                        <p class="text-sm">No active diagnoses</p>
                                    </div>

                                    <!-- Active diagnosis list items -->
                                    <template x-for="diagnosis in activeDiagnoses" :key="diagnosis.id">
                                        <div
                                            class="diagnosis-list-item"
                                            :class="{
                                                'selected': selectedDiagnosisId === diagnosis.id,
                                                'principal': diagnosis.isPrincipal
                                            }"
                                            @click="selectDiagnosisForEdit(diagnosis)"
                                        >
                                            <!-- Principal star -->
                                            <svg x-show="diagnosis.isPrincipal" class="icon icon-sm diagnosis-list-item-star"><use href="./assets/icons/tabler-sprites.svg#principal"></use></svg>

                                            <div class="diagnosis-list-item-content" :class="{ 'ml-5': !diagnosis.isPrincipal }">
                                                <div class="diagnosis-list-item-code" x-text="diagnosis.icd10Code"></div>
                                                <div class="diagnosis-list-item-name" x-text="diagnosis.description"></div>
                                                <div class="diagnosis-list-item-meta">
                                                    <span
                                                        class="diagnosis-list-item-badge"
                                                        :class="diagnosis.status"
                                                        x-text="diagnosis.status"
                                                    ></span>
                                                    <span
                                                        x-show="diagnosis.severity"
                                                        class="diagnosis-list-item-badge severity"
                                                        x-text="diagnosis.severity"
                                                    ></span>
                                                </div>
                                            </div>
                                        </div>
                                    </template>

                                    <!-- Resolved Section (collapsible) -->
                                    <template x-if="resolvedDiagnoses.length > 0">
                                        <div>
                                            <button
                                                type="button"
                                                class="section-toggle"
                                                @click="showResolvedDiagnoses = !showResolvedDiagnoses"
                                            >
                                                <svg class="icon icon-md"><use :href="showResolvedDiagnoses ? './assets/icons/tabler-sprites.svg#expand' : './assets/icons/tabler-sprites.svg#collapsed-indicator'"></use></svg>
                                                Resolved (<span x-text="resolvedDiagnoses.length"></span>)
                                            </button>

                                            <template x-if="showResolvedDiagnoses">
                                                <div>
                                                    <template x-for="diagnosis in resolvedDiagnoses" :key="diagnosis.id">
                                                        <div
                                                            class="diagnosis-list-item resolved"
                                                            :class="{ 'selected': selectedDiagnosisId === diagnosis.id }"
                                                            @click="selectDiagnosisForEdit(diagnosis)"
                                                        >
                                                            <div class="diagnosis-list-item-content ml-5">
                                                                <div class="diagnosis-list-item-code" x-text="diagnosis.icd10Code"></div>
                                                                <div class="diagnosis-list-item-name" x-text="diagnosis.description"></div>
                                                                <div class="diagnosis-list-item-meta">
                                                                    <span class="diagnosis-list-item-badge resolved">resolved</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </template>

                                    <!-- Add New Button (only for users with edit access) -->
                                    <button
                                        x-show="!isSupervisor && userRole !== 'sysadmin'"
                                        type="button"
                                        class="list-add-btn"
                                        @click="startAddNewDiagnosis()"
                                    >
                                        <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-add"></use></svg>
                                        Add New Diagnosis
                                    </button>

                                </div>
                            </div>

                            <!-- ========================================
                                 RIGHT PANEL: FORM
                                 ======================================== -->
                            <div class="form-panel">

                                <!-- Empty State (no selection) -->
                                <div x-show="!selectedDiagnosisId && !isAddingNewDiagnosis" class="empty-state">
                                    <svg class="icon icon-2xl"><use href="./assets/icons/tabler-sprites.svg#document-empty"></use></svg>
                                    <p class="text-sm">Select a diagnosis to view details<br>or add a new one</p>
                                </div>

                                <!-- Form Content (when editing or adding) -->
                                <template x-if="selectedDiagnosisId || isAddingNewDiagnosis">
                                    <div>
                                        <!-- Form Header -->
                                        <div class="form-panel-header">
                                            <h2 class="text-sm font-bold text-neutral-800">
                                                <span x-show="isAddingNewDiagnosis">Add New Diagnosis</span>
                                                <span x-show="selectedDiagnosisId">Edit Diagnosis</span>
                                            </h2>
                                            <button
                                                type="button"
                                                class="btn btn-ghost btn-sm"
                                                @click="clearDiagnosisSelection()"
                                                title="Close"
                                            >
                                                <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                                            </button>
                                        </div>

                                        <!-- Form Body -->
                                        <form @submit.prevent="saveDiagnosis()" class="form-panel-body space-y-4">

                                            <!-- ICD-10 Code and Description -->
                                            <div class="grid grid-cols-3 gap-4">
                                                <div class="form-group">
                                                    <label class="form-label">ICD-10 Code <span class="text-danger-500">*</span></label>
                                                    <input
                                                        type="text"
                                                        x-model="newDiagnosis.icd10Code"
                                                        class="form-input font-mono"
                                                        :class="{ 'border-danger-500': diagnosisErrors.icd10Code }"
                                                        @blur="diagnosisErrors.icd10Code = validateDiagnosisField('icd10Code')"
                                                        @input="clearDiagnosisError('icd10Code')"
                                                        placeholder="F41.1"
                                                        required
                                                    >
                                                    <p x-show="diagnosisErrors.icd10Code" x-text="diagnosisErrors.icd10Code" class="form-error mt-1"></p>
                                                </div>
                                                <div class="form-group col-span-2">
                                                    <label class="form-label">Description <span class="text-danger-500">*</span></label>
                                                    <input
                                                        type="text"
                                                        x-model="newDiagnosis.description"
                                                        class="form-input"
                                                        :class="{ 'border-danger-500': diagnosisErrors.description }"
                                                        @blur="diagnosisErrors.description = validateDiagnosisField('description')"
                                                        @input="clearDiagnosisError('description')"
                                                        placeholder="Generalized Anxiety Disorder"
                                                        required
                                                    >
                                                    <p x-show="diagnosisErrors.description" x-text="diagnosisErrors.description" class="form-error mt-1"></p>
                                                </div>
                                            </div>

                                            <!-- Date of Diagnosis -->
                                            <div class="form-group">
                                                <label class="form-label">Date of Diagnosis <span class="text-danger-500">*</span></label>
                                                <input
                                                    type="date"
                                                    x-model="newDiagnosis.dateOfDiagnosis"
                                                    class="form-input"
                                                    :class="{ 'border-danger-500': diagnosisErrors.dateOfDiagnosis }"
                                                    @blur="diagnosisErrors.dateOfDiagnosis = validateDiagnosisField('dateOfDiagnosis')"
                                                    @input="clearDiagnosisError('dateOfDiagnosis')"
                                                    required
                                                >
                                                <p x-show="diagnosisErrors.dateOfDiagnosis" x-text="diagnosisErrors.dateOfDiagnosis" class="form-error mt-1"></p>
                                            </div>

                                            <!-- Status -->
                                            <div class="form-group">
                                                <label class="form-label">Status</label>
                                                <p class="text-xs text-neutral-500 mb-2">Provisional = still assessing; Active = confirmed; Resolved = no longer clinically significant</p>
                                                <div class="btn-radio-group">
                                                    <button type="button" class="btn-radio"
                                                        :class="{ 'checked': newDiagnosis.status === 'provisional' }"
                                                        @click="newDiagnosis.status = 'provisional'">
                                                        <svg class="icon icon-sm"><use :href="newDiagnosis.status === 'provisional' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                        Provisional
                                                    </button>
                                                    <button type="button" class="btn-radio"
                                                        :class="{ 'checked': newDiagnosis.status === 'active' }"
                                                        @click="newDiagnosis.status = 'active'">
                                                        <svg class="icon icon-sm"><use :href="newDiagnosis.status === 'active' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                        Active
                                                    </button>
                                                    <button type="button" class="btn-radio"
                                                        :class="{ 'checked': newDiagnosis.status === 'resolved' }"
                                                        @click="newDiagnosis.status = 'resolved'">
                                                        <svg class="icon icon-sm"><use :href="newDiagnosis.status === 'resolved' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                        Resolved
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Date Resolved (shown when status is resolved) -->
                                            <div x-show="newDiagnosis.status === 'resolved'" x-transition class="form-group">
                                                <label class="form-label">Date Resolved <span class="text-danger-500">*</span></label>
                                                <input
                                                    type="date"
                                                    x-model="newDiagnosis.dateResolved"
                                                    class="form-input"
                                                    :class="{ 'border-danger-500': diagnosisErrors.dateResolved }"
                                                    @blur="diagnosisErrors.dateResolved = validateDiagnosisField('dateResolved')"
                                                    @input="clearDiagnosisError('dateResolved')"
                                                >
                                                <p x-show="diagnosisErrors.dateResolved" x-text="diagnosisErrors.dateResolved" class="form-error mt-1"></p>
                                            </div>

                                            <!-- Principal Diagnosis -->
                                            <div class="form-group">
                                                <label class="form-label">Principal Diagnosis</label>
                                                <p class="text-xs text-neutral-500 mb-2">The primary focus of treatment; required for insurance billing</p>
                                                <button
                                                    type="button"
                                                    class="btn-checkbox"
                                                    :class="{ 'checked': newDiagnosis.isPrincipal }"
                                                    :disabled="newDiagnosis.status === 'resolved'"
                                                    @click="newDiagnosis.isPrincipal = !newDiagnosis.isPrincipal"
                                                >
                                                    <svg class="icon icon-md"><use :href="newDiagnosis.isPrincipal ? './assets/icons/tabler-sprites.svg#principal' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                    <span x-text="newDiagnosis.isPrincipal ? 'This is the principal diagnosis' : 'Make this the principal diagnosis'"></span>
                                                </button>
                                            </div>

                                            <!-- Severity -->
                                            <div class="form-group">
                                                <label class="form-label">Severity <span class="text-neutral-500 font-normal">(optional)</span></label>
                                                <div class="btn-radio-group">
                                                    <button type="button" class="btn-radio"
                                                        :class="{ 'checked': newDiagnosis.severity === null }"
                                                        @click="newDiagnosis.severity = null">
                                                        <svg class="icon icon-sm"><use :href="newDiagnosis.severity === null ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                        Unspecified
                                                    </button>
                                                    <button type="button" class="btn-radio"
                                                        :class="{ 'checked': newDiagnosis.severity === 'mild' }"
                                                        @click="newDiagnosis.severity = 'mild'">
                                                        <svg class="icon icon-sm"><use :href="newDiagnosis.severity === 'mild' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                        Mild
                                                    </button>
                                                    <button type="button" class="btn-radio"
                                                        :class="{ 'checked': newDiagnosis.severity === 'moderate' }"
                                                        @click="newDiagnosis.severity = 'moderate'">
                                                        <svg class="icon icon-sm"><use :href="newDiagnosis.severity === 'moderate' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                        Moderate
                                                    </button>
                                                    <button type="button" class="btn-radio"
                                                        :class="{ 'checked': newDiagnosis.severity === 'severe' }"
                                                        @click="newDiagnosis.severity = 'severe'">
                                                        <svg class="icon icon-sm"><use :href="newDiagnosis.severity === 'severe' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                                        Severe
                                                    </button>
                                                </div>
                                            </div>

                                            <!-- Clinical Notes -->
                                            <div class="form-group">
                                                <label class="form-label">Clinical Notes <span class="text-neutral-500 font-normal">(optional)</span></label>
                                                <textarea
                                                    x-model="newDiagnosis.clinicalNotes"
                                                    class="form-textarea"
                                                    rows="3"
                                                    placeholder="Additional clinical observations or notes about this diagnosis..."
                                                ></textarea>
                                            </div>

                                            <!-- Form Footer -->
                                            <div class="flex justify-end gap-3 pt-4 border-t border-neutral-200">
                                                <button
                                                    type="button"
                                                    @click="clearDiagnosisSelection()"
                                                    class="btn btn-ghost"
                                                >
                                                    Cancel
                                                </button>
                                                <button
                                                    x-show="selectedDiagnosisId"
                                                    type="button"
                                                    @click="resolveDiagnosis(selectedDiagnosisId)"
                                                    class="btn btn-secondary"
                                                    :disabled="newDiagnosis.status === 'resolved'"
                                                >
                                                    <svg class="icon icon-md mr-1"><use href="./assets/icons/tabler-sprites.svg#action-resolve"></use></svg>
                                                    Resolve
                                                </button>
                                                <button
                                                    type="submit"
                                                    class="btn btn-primary"
                                                    :disabled="!canSaveDiagnosis || savingDiagnosis"
                                                >
                                                    <span x-show="!savingDiagnosis" class="flex items-center">
                                                        <svg class="icon mr-2"><use href="./assets/icons/custom-sprites.svg#action-save"></use></svg>
                                                        <span x-show="isAddingNewDiagnosis">Save Diagnosis</span>
                                                        <span x-show="selectedDiagnosisId">Update</span>
                                                    </span>
                                                    <span x-show="savingDiagnosis" class="flex items-center">
                                                        <blob-spinner class="mr-2"></blob-spinner>
                                                        Saving...
                                                    </span>
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </template>

                            </div>

                        </div>
                    </div>

                    <!-- ========================================
                         INTAKE FORM (Beta)
                         ======================================== -->
                    <div x-show="formType === 'Intake'" class="space-y-6">

                        <!-- Form Header with Status -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h2>Intake Assessment</h2>
                                <span class="badge badge-beta text-xs">Beta</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span x-show="savingIntake" class="text-neutral-400 text-sm flex items-center">
                                    <blob-spinner class="icon-sm mr-1"></blob-spinner>
                                    Saving...
                                </span>
                                <span x-show="intakeStatus === 'complete'" x-cloak class="badge badge-success text-xs">
                                    Complete
                                </span>
                                <span x-show="intakeStatus === 'draft' && existingIntakeId" x-cloak class="badge badge-warning text-xs">
                                    Draft
                                </span>
                            </div>
                        </div>

                        <!-- Session Details Card -->
                        <div class="card" id="intake-session-details">
                            <div class="card-header">
                                <h3 class="font-semibold">Session Details</h3>
                            </div>
                            <div class="card-body space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                    <div class="form-group">
                                        <label class="form-label" for="intake-date">Date</label>
                                        <input type="date" id="intake-date" x-model="currentIntake.date" class="form-input" :class="{ 'border-danger-500': intakeErrors.date }" @input="intakeErrors.date = ''">
                                        <p x-show="intakeErrors.date" class="text-sm text-danger-600 mt-1" x-text="intakeErrors.date"></p>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="intake-duration">Duration (min)</label>
                                        <input type="number" id="intake-duration" x-model.number="currentIntake.duration" class="form-input" min="15" step="15">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="intake-delivery">Delivery</label>
                                        <select id="intake-delivery" x-model="currentIntake.delivery" class="form-select">
                                            <option value="In Person">In Person</option>
                                            <option value="Video">Video</option>
                                            <option value="Phone">Phone</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Presenting Problems Card -->
                        <div class="card" id="intake-presenting-problems" :class="{ 'border-danger-500': intakeErrors.presentingProblems }">
                            <div class="card-header">
                                <h3 class="font-semibold">Presenting Problems</h3>
                            </div>
                            <div class="card-body space-y-4">
                                <p class="text-sm text-neutral-600">Select all that apply:</p>
                                <p x-show="intakeErrors.presentingProblems" class="text-sm text-danger-600" x-text="intakeErrors.presentingProblems"></p>
                                <div class="btn-checkbox-group">
                                    <template x-for="issue in allPresentingIssues" :key="issue.id">
                                        <button
                                            type="button"
                                            class="btn-checkbox"
                                            :class="{ 'active': isIntakePresentingProblemSelected(issue.id) }"
                                            @click="toggleIntakePresentingProblem(issue.id); intakeErrors.presentingProblems = ''"
                                        >
                                            <span x-text="issue.name"></span>
                                        </button>
                                    </template>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="intake-problems-other">Other (specify)</label>
                                    <input type="text" id="intake-problems-other" x-model="currentIntake.presentingProblemsOther" class="form-input" placeholder="Additional presenting problems...">
                                </div>
                            </div>
                        </div>

                        <!-- Risk Assessment Card -->
                        <div class="card" id="intake-risk-assessment">
                            <div class="card-header flex items-center justify-between">
                                <h3 class="font-semibold">Risk Assessment</h3>
                                <span class="badge text-xs" :class="intakeRiskLevelClass" x-text="currentIntake.riskAssessment.riskLevel.charAt(0).toUpperCase() + currentIntake.riskAssessment.riskLevel.slice(1)"></span>
                            </div>
                            <div class="card-body space-y-4">
                                <div class="space-y-3">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" x-model="currentIntake.riskAssessment.suicidalIdeation" @change="updateIntakeRiskLevel()" class="form-checkbox">
                                        <span class="text-sm">Suicidal Ideation</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" x-model="currentIntake.riskAssessment.homicidalIdeation" @change="updateIntakeRiskLevel()" class="form-checkbox">
                                        <span class="text-sm">Homicidal Ideation</span>
                                    </label>
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="checkbox" x-model="currentIntake.riskAssessment.selfHarm" @change="updateIntakeRiskLevel()" class="form-checkbox">
                                        <span class="text-sm">Self-Harm</span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Risk Level</label>
                                    <div class="btn-radio-group">
                                        <button type="button" class="btn-radio" :class="{ 'checked': currentIntake.riskAssessment.riskLevel === 'standard' }" @click="currentIntake.riskAssessment.riskLevel = 'standard'">
                                            <svg class="icon icon-sm"><use :href="currentIntake.riskAssessment.riskLevel === 'standard' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                            Standard
                                        </button>
                                        <button type="button" class="btn-radio" :class="{ 'checked': currentIntake.riskAssessment.riskLevel === 'elevated' }" @click="currentIntake.riskAssessment.riskLevel = 'elevated'">
                                            <svg class="icon icon-sm"><use :href="currentIntake.riskAssessment.riskLevel === 'elevated' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                            Elevated
                                        </button>
                                        <button type="button" class="btn-radio" :class="{ 'checked': currentIntake.riskAssessment.riskLevel === 'high' }" @click="currentIntake.riskAssessment.riskLevel = 'high'">
                                            <svg class="icon icon-sm"><use :href="currentIntake.riskAssessment.riskLevel === 'high' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                            High
                                        </button>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="intake-risk-notes">Risk Notes</label>
                                    <textarea id="intake-risk-notes" x-model="currentIntake.riskAssessment.notes" class="form-textarea" rows="2" placeholder="Additional risk assessment notes..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Clinical History Card -->
                        <div class="card" id="intake-clinical-history">
                            <div class="card-header">
                                <h3 class="font-semibold">Clinical History</h3>
                            </div>
                            <div class="card-body space-y-4">
                                <div class="form-group">
                                    <label class="form-label" for="intake-mh-history">Mental Health History</label>
                                    <textarea id="intake-mh-history" x-model="currentIntake.mentalHealthHistory" class="form-textarea" rows="3" placeholder="Previous diagnoses, treatments, hospitalizations..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="intake-med-history">Medical History</label>
                                    <textarea id="intake-med-history" x-model="currentIntake.medicalHistory" class="form-textarea" rows="2" placeholder="Relevant medical conditions..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="intake-substance">Substance Use</label>
                                    <textarea id="intake-substance" x-model="currentIntake.substanceUse" class="form-textarea" rows="2" placeholder="Current and historical substance use..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="intake-social">Social History</label>
                                    <textarea id="intake-social" x-model="currentIntake.socialHistory" class="form-textarea" rows="2" placeholder="Living situation, relationships, support systems..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Clinical Conceptualization Card -->
                        <div class="card" id="intake-conceptualization">
                            <div class="card-header">
                                <h3 class="font-semibold">Clinical Conceptualization</h3>
                            </div>
                            <div class="card-body space-y-4">
                                <div class="form-group">
                                    <label class="form-label" for="intake-coherence">Coherence Lens</label>
                                    <textarea id="intake-coherence" x-model="currentIntake.conceptualization.coherence" class="form-textarea" rows="3" placeholder="Narrative coherence, meaning-making, identity..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="intake-attachment">Attachment Lens</label>
                                    <textarea id="intake-attachment" x-model="currentIntake.conceptualization.attachment" class="form-textarea" rows="3" placeholder="Attachment patterns, relational dynamics..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="intake-somatic">Somatic Lens</label>
                                    <textarea id="intake-somatic" x-model="currentIntake.conceptualization.somatic" class="form-textarea" rows="3" placeholder="Body awareness, nervous system regulation, physical manifestations..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Treatment Recommendations Card -->
                        <div class="card" id="intake-recommendations">
                            <div class="card-header">
                                <h3 class="font-semibold">Treatment Recommendations</h3>
                            </div>
                            <div class="card-body">
                                <div class="form-group">
                                    <textarea id="intake-treatment-rec" x-model="currentIntake.treatmentRecommendations" class="form-textarea" rows="4" placeholder="Recommended treatment approach, frequency, initial goals..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" @click="resetIntakeForm()" class="btn btn-secondary" :disabled="savingIntake">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#action-reset"></use></svg>
                                Reset
                            </button>
                            <button type="button" @click="saveIntake('draft')" class="btn btn-secondary" :disabled="savingIntake">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/custom-sprites.svg#action-save"></use></svg>
                                Save Draft
                            </button>
                            <button type="button" @click="submitIntake()" class="btn btn-primary" :disabled="savingIntake">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#success"></use></svg>
                                Complete Intake
                            </button>
                        </div>

                    </div>

                    <!-- ========================================
                         TREATMENT PLAN FORM (Beta)
                         ======================================== -->
                    <div x-show="formType === 'Treatment Plan'" class="space-y-6">

                        <!-- Form Header with Status -->
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h2>Treatment Plan</h2>
                                <span class="badge badge-beta text-xs">Beta</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <span x-show="savingTreatmentPlan" class="text-neutral-400 text-sm flex items-center">
                                    <blob-spinner class="icon-sm mr-1"></blob-spinner>
                                    Saving...
                                </span>
                                <span x-show="treatmentPlanStatus === 'active'" x-cloak class="badge badge-success text-xs">
                                    Active
                                </span>
                                <span x-show="treatmentPlanStatus === 'draft' && existingTreatmentPlanId" x-cloak class="badge badge-warning text-xs">
                                    Draft
                                </span>
                            </div>
                        </div>

                        <!-- Linked Intake Banner -->
                        <div x-show="linkedIntakeForPlan" x-cloak class="alert-info flex items-center gap-2">
                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#linked"></use></svg>
                            <span>Based on intake assessment from <strong x-text="linkedIntakeDateForPlan"></strong></span>
                        </div>

                        <!-- Plan Details Card -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Plan Details</h3>
                            </div>
                            <div class="card-body space-y-4">
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label" for="plan-date">Date Created</label>
                                        <input type="date" id="plan-date" x-model="currentTreatmentPlan.dateCreated" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="plan-review">Review Date</label>
                                        <input type="date" id="plan-review" x-model="currentTreatmentPlan.reviewDate" class="form-input">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Presenting Problems Card -->
                        <div class="card">
                            <div class="card-header flex items-center justify-between">
                                <h3 class="font-semibold">Presenting Problems</h3>
                                <span x-show="currentTreatmentPlan.presentingProblemsSource === 'intake'" x-cloak class="badge badge-info text-xs">From Intake</span>
                            </div>
                            <div class="card-body space-y-4">
                                <p class="text-sm text-neutral-600">Select all that apply:</p>
                                <div class="btn-checkbox-group">
                                    <template x-for="issue in allPresentingIssues" :key="issue.id">
                                        <button
                                            type="button"
                                            class="btn-checkbox"
                                            :class="{ 'active': isTreatmentPlanPresentingProblemSelected(issue.id) }"
                                            @click="toggleTreatmentPlanPresentingProblem(issue.id)"
                                        >
                                            <span x-text="issue.name"></span>
                                        </button>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Goals Card -->
                        <div class="card" :class="{ 'border-danger-500': treatmentPlanErrors.goals }">
                            <div class="card-header flex items-center justify-between">
                                <h3 class="font-semibold">Treatment Goals</h3>
                                <button type="button" @click="addGoal()" class="btn btn-sm btn-secondary" :disabled="!canAddGoal">
                                    <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#action-add"></use></svg>
                                    Add Goal
                                </button>
                            </div>
                            <div class="card-body space-y-4">
                                <p x-show="treatmentPlanErrors.goals" class="text-sm text-danger-600" x-text="treatmentPlanErrors.goals"></p>
                                <!-- Goal Tabs -->
                                <div class="flex gap-2 border-b border-neutral-200 pb-2">
                                    <template x-for="(goal, index) in currentTreatmentPlan.goals" :key="goal.id">
                                        <button
                                            type="button"
                                            class="px-4 py-2 text-sm font-medium rounded-t-lg transition-colors"
                                            :class="activeGoalIndex === index ? 'bg-primary-500 text-white' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'"
                                            @click="selectGoal(index)"
                                        >
                                            Goal <span x-text="index + 1"></span>
                                        </button>
                                    </template>
                                </div>

                                <!-- Current Goal Form -->
                                <div x-show="currentGoal" class="space-y-4">
                                    <div class="form-group">
                                        <label class="form-label">Goal Description</label>
                                        <textarea x-model="currentGoal.text" @input="treatmentPlanErrors.goals = ''" class="form-textarea" rows="3" placeholder="Describe the treatment goal..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Target Date</label>
                                        <input type="date" x-model="currentGoal.targetDate" class="form-input">
                                    </div>

                                    <!-- Interventions for this Goal -->
                                    <div class="form-group">
                                        <label class="form-label flex items-center justify-between">
                                            <span>Interventions</span>
                                            <button type="button" @click="toggleReferenceDrawer()" class="btn btn-sm btn-ghost text-primary-600">
                                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#interventions"></use></svg>
                                                Browse Library
                                            </button>
                                        </label>
                                        <div class="space-y-2">
                                            <template x-for="(intervention, iIndex) in currentGoal.interventions" :key="intervention.id">
                                                <div class="flex items-center gap-2 p-2 bg-neutral-50 rounded-lg">
                                                    <span class="flex-1 text-sm" x-text="intervention.name"></span>
                                                    <span class="badge text-xs" x-text="intervention.approach"></span>
                                                    <button type="button" @click="removeInterventionFromGoal(activeGoalIndex, iIndex)" class="btn-icon btn-sm text-danger-500">
                                                        <svg class="icon icon-sm"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                                                    </button>
                                                </div>
                                            </template>
                                            <div x-show="!currentGoal.interventions || currentGoal.interventions.length === 0" class="text-sm text-neutral-400 italic">
                                                No interventions added yet. Click "Browse Library" to add.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Custom Intervention Entry -->
                                    <div class="flex gap-2">
                                        <input type="text" x-model="customIntervention.name" class="form-input flex-1" placeholder="Add custom intervention...">
                                        <button type="button" @click="addCustomInterventionToGoal()" class="btn btn-secondary" :disabled="!customIntervention.name.trim()">
                                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#action-add"></use></svg>
                                        </button>
                                    </div>

                                    <!-- Remove Goal Button -->
                                    <div x-show="currentTreatmentPlan.goals.length > 1" class="pt-2">
                                        <button type="button" @click="removeGoal(activeGoalIndex)" class="btn btn-ghost text-danger-600 text-sm">
                                            <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#action-delete"></use></svg>
                                            Remove this goal
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Client Acknowledgment Card -->
                        <div class="card">
                            <div class="card-header">
                                <h3 class="font-semibold">Client Acknowledgment</h3>
                            </div>
                            <div class="card-body space-y-3">
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" x-model="currentTreatmentPlan.reviewedWithClient" class="form-checkbox">
                                    <span class="text-sm">Treatment plan reviewed with client</span>
                                </label>
                                <label class="flex items-center gap-3 cursor-pointer">
                                    <input type="checkbox" x-model="currentTreatmentPlan.clientAgrees" class="form-checkbox">
                                    <span class="text-sm">Client agrees with treatment goals</span>
                                </label>
                                <div class="form-group">
                                    <label class="form-label" for="plan-notes">Additional Notes</label>
                                    <textarea id="plan-notes" x-model="currentTreatmentPlan.notes" class="form-textarea" rows="2" placeholder="Any additional notes about the treatment plan..."></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex justify-end gap-3 pt-4">
                            <button type="button" @click="resetTreatmentPlanForm()" class="btn btn-secondary" :disabled="savingTreatmentPlan">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#action-reset"></use></svg>
                                Reset
                            </button>
                            <button type="button" @click="saveTreatmentPlan('draft')" class="btn btn-secondary" :disabled="savingTreatmentPlan">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/custom-sprites.svg#action-save"></use></svg>
                                Save Draft
                            </button>
                            <button type="button" @click="activateTreatmentPlan()" class="btn btn-primary" :disabled="savingTreatmentPlan">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#success"></use></svg>
                                Activate Plan
                            </button>
                        </div>

                    </div>

                    <!-- Clinical Reference Drawer (for Treatment Plan) -->
                    <div
                        x-show="showReferenceDrawer"
                        x-cloak
                        class="fixed inset-0 z-50"
                        @keydown.escape.window="closeReferenceDrawer()"
                    >
                        <!-- Backdrop -->
                        <div class="absolute inset-0 bg-black/30" @click="closeReferenceDrawer()"></div>

                        <!-- Drawer Panel -->
                        <div class="absolute right-0 top-0 h-full w-full max-w-md bg-white shadow-xl flex flex-col">
                            <div class="p-4 border-b border-neutral-200 flex items-center justify-between">
                                <h3 class="font-semibold text-lg">Intervention Library</h3>
                                <button type="button" @click="closeReferenceDrawer()" class="btn-icon">
                                    <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                                </button>
                            </div>

                            <!-- Filter -->
                            <div class="p-4 border-b border-neutral-200">
                                <select x-model="referenceFilter" class="form-select">
                                    <option value="all">All Approaches</option>
                                    <template x-for="approach in allApproaches" :key="approach">
                                        <option :value="approach" x-text="approach"></option>
                                    </template>
                                </select>
                            </div>

                            <!-- Intervention List -->
                            <div class="flex-1 overflow-y-auto p-4 space-y-2">
                                <template x-for="intervention in filteredReferenceInterventions" :key="intervention.id">
                                    <div class="p-3 border border-neutral-200 rounded-lg hover:bg-neutral-50 flex items-center justify-between">
                                        <div class="flex-1 min-w-0">
                                            <p class="font-medium text-sm" x-text="intervention.name"></p>
                                            <p class="text-xs text-neutral-500" x-text="intervention.approach"></p>
                                        </div>
                                        <button
                                            type="button"
                                            @click="addInterventionToCurrentGoal(intervention)"
                                            class="btn btn-sm btn-primary"
                                            :disabled="!canAddInterventionToGoal(intervention.id)"
                                        >
                                            <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-add"></use></svg>
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>

                    <!-- Session Note Form (Progress Note) -->
                    <form x-show="formType === 'Progress Note'" @submit.prevent="submitNote" class="card space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <h2>Progress Note</h2>
                                <!-- Mode Badge -->
                                <span x-show="!(isEditingExisting || amendmentOf)" x-cloak class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-primary-100 text-primary-800">
                                    <svg class="icon icon-xs mr-1"><use href="./assets/icons/tabler-sprites.svg#status-new"></use></svg>
                                    New
                                </span>
                                <span x-show="isEditingExisting" x-cloak class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-warning-100 text-warning-800">
                                    <svg class="icon icon-xs mr-1"><use href="./assets/icons/tabler-sprites.svg#status-editing"></use></svg>
                                    Editing
                                </span>
                                <span x-show="amendmentOf" x-cloak class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-primary-100 text-primary-800">
                                    <svg class="icon icon-xs mr-1"><use href="./assets/icons/tabler-sprites.svg#status-amending"></use></svg>
                                    Amendment
                                </span>
                            </div>
                            <!-- Status Indicators -->
                            <div class="flex items-center text-sm gap-3">
                                <!-- Note Saved Indicator -->
                                <span
                                    x-show="noteLastSaved"
                                    x-transition
                                    class="text-success-600 flex items-center"
                                >
                                    <svg class="icon icon-sm mr-1.5"><use href="./assets/icons/tabler-sprites.svg#success"></use></svg>
                                    Saved <span class="text-neutral-500 ml-1" x-text="formatNoteSavedTime()"></span>
                                </span>
                                <!-- Draft Status Indicator -->
                                <span
                                    x-show="draftStatus === 'saving'"
                                    class="text-neutral-400 flex items-center"
                                >
                                    <blob-spinner class="icon-xs mr-1.5"></blob-spinner>
                                    Saving...
                                </span>
                                <span
                                    x-show="draftStatus === 'saved' && !noteLastSaved"
                                    x-transition
                                    class="text-success-600 flex items-center"
                                >
                                    <svg class="icon icon-sm mr-1.5"><use href="./assets/icons/tabler-sprites.svg#draft-saved"></use></svg>
                                    Draft saved <span class="text-neutral-500 ml-1" x-text="formatDraftTime()"></span>
                                </span>
                            </div>
                        </div>

                        <!-- Info Banner: Session timing or orphan warnings -->
                        <div
                            x-show="showOrphanBanner && (duplicateWarnings.tooSoonForBasis || duplicateWarnings.orphanedDrafts.length > 0)"
                            x-transition:enter="transition ease-out duration-200"
                            x-transition:enter-start="opacity-0 transform -translate-y-2"
                            x-transition:enter-end="opacity-100 transform translate-y-0"
                            x-transition:leave="transition ease-in duration-150"
                            x-transition:leave-start="opacity-100"
                            x-transition:leave-end="opacity-0"
                            class="p-3 bg-info-50 rounded-lg border border-info-200"
                        >
                            <div class="flex justify-between items-start">
                                <div class="flex items-start gap-2">
                                    <svg class="icon text-info-600 mt-0.5 shrink-0"><use href="./assets/icons/tabler-sprites.svg#info"></use></svg>
                                    <div class="space-y-1">
                                        <template x-if="duplicateWarnings.tooSoonForBasis">
                                            <p class="text-sm text-info-800">
                                                <strong>Session timing:</strong>
                                                This session date appears sooner than the client's typical schedule.
                                            </p>
                                        </template>
                                        <template x-if="duplicateWarnings.orphanedDrafts.length > 0">
                                            <p class="text-sm text-info-800">
                                                <strong>Orphaned drafts:</strong>
                                                You have <span x-text="duplicateWarnings.orphanedDrafts.length"></span>
                                                older draft<span x-show="duplicateWarnings.orphanedDrafts.length > 1">s</span>
                                                that may need attention.
                                            </p>
                                        </template>
                                    </div>
                                </div>
                                <button
                                    type="button"
                                    @click="dismissOrphanBanner()"
                                    class="btn-icon btn-icon-sm text-info-600 hover:text-info-800"
                                    aria-label="Dismiss"
                                >
                                    <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#x"></use></svg>
                                </button>
                            </div>
                        </div>

                        <!-- Amendment Info Banner -->
                        <div
                            x-show="amendmentOf"
                            x-cloak
                            class="p-3 bg-primary-50 rounded-lg border border-primary-200"
                        >
                            <div class="flex items-start gap-2">
                                <svg class="icon text-primary-600 mt-0.5 shrink-0"><use href="./assets/icons/tabler-sprites.svg#action-amend"></use></svg>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-primary-800">Creating Amendment</p>
                                    <p class="text-sm text-primary-700 mt-1">
                                        <span class="font-medium">Reason:</span>
                                        <span x-text="amendmentReason"></span>
                                    </p>
                                    <p class="text-xs text-primary-600 mt-2">
                                        This will create a new document linked to the original. The original note will remain unchanged.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="session-date">Session Date <span class="text-danger-500">*</span></label>
                            <input
                                type="date"
                                id="session-date"
                                x-model="currentNote.date"
                                class="form-input"
                                :class="{ 'border-danger-500': formErrors.date, 'bg-neutral-100 cursor-not-allowed': isEditingExisting || amendmentOf }"
                                :readonly="isEditingExisting || amendmentOf"
                                @blur="formErrors.date = validateProgressNoteField('date'); checkDateWarning()"
                                @input="clearFormError('date'); checkDateWarning()"
                                required
                            >
                            <p x-show="(isEditingExisting || amendmentOf)" x-cloak class="text-sm text-neutral-500 mt-1 flex items-center gap-1">
                                <svg class="icon icon-sm"><use href="./assets/icons/tabler-sprites.svg#info"></use></svg>
                                Date cannot be changed when editing or amending
                            </p>
                            <p x-show="formErrors.date" x-text="formErrors.date" class="form-error mt-1"></p>
                            <p x-show="dateWarning && !formErrors.date && !duplicateSessionWarning" class="text-warning-600 text-sm mt-1 flex items-center gap-1">
                                <svg class="icon icon-sm"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                                <span x-text="dateWarning"></span>
                            </p>
                            <!-- Duplicate Session Warning -->
                            <div x-show="duplicateSessionWarning && !formErrors.date" class="mt-2 p-3 bg-warning-50 border border-warning-200 rounded-lg">
                                <div class="flex items-start gap-2">
                                    <svg class="icon icon-sm text-warning-600 mt-0.5"><use href="./assets/icons/tabler-sprites.svg#warning-duplicate"></use></svg>
                                    <div class="flex-1">
                                        <p class="text-sm text-warning-800 font-medium">
                                            A session note already exists for this date
                                        </p>
                                        <p class="text-xs text-warning-600 mt-1">
                                            You can continue to create a new note, or change the date.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="duration">Duration (minutes) <span class="text-danger-500">*</span></label>
                            <input
                                type="number"
                                id="duration"
                                x-model.number="currentNote.duration"
                                class="form-input"
                                :class="{ 'border-danger-500': formErrors.duration }"
                                @blur="formErrors.duration = validateProgressNoteField('duration')"
                                @input="clearFormError('duration')"
                                min="15"
                                max="100"
                                step="5"
                                required
                            >
                            <p x-show="formErrors.duration" x-text="formErrors.duration" class="form-error mt-1"></p>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Delivery</label>
                            <div class="btn-radio-group">
                                <button
                                    type="button"
                                    class="btn-radio"
                                    :class="{ 'checked': delivery === 'In Person' }"
                                    @click="delivery = 'In Person'; deliveryOther = ''; clearFormError('deliveryOther')"
                                >
                                    <svg class="icon icon-md"><use :href="delivery === 'In Person' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                    In Person
                                </button>
                                <button
                                    type="button"
                                    class="btn-radio"
                                    :class="{ 'checked': delivery === 'Video' }"
                                    @click="delivery = 'Video'; deliveryOther = ''; clearFormError('deliveryOther')"
                                >
                                    <svg class="icon icon-md"><use :href="delivery === 'Video' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                    Video
                                </button>
                                <button
                                    type="button"
                                    class="btn-radio"
                                    :class="{ 'checked': delivery === 'Phone' }"
                                    @click="delivery = 'Phone'; deliveryOther = ''; clearFormError('deliveryOther')"
                                >
                                    <svg class="icon icon-md"><use :href="delivery === 'Phone' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                    Phone
                                </button>
                                <button
                                    type="button"
                                    class="btn-radio"
                                    :class="{ 'checked': delivery === 'Other' }"
                                    @click="delivery = 'Other'"
                                >
                                    <svg class="icon icon-md"><use :href="delivery === 'Other' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                    Other
                                </button>
                            </div>
                            <!-- Other delivery method text input -->
                            <div x-show="delivery === 'Other'" x-transition class="mt-2">
                                <input
                                    type="text"
                                    x-model="deliveryOther"
                                    class="form-input"
                                    :class="{ 'border-danger-500': formErrors.deliveryOther }"
                                    @blur="formErrors.deliveryOther = validateProgressNoteField('deliveryOther')"
                                    @input="clearFormError('deliveryOther')"
                                    placeholder="Describe delivery method..."
                                >
                                <p x-show="formErrors.deliveryOther" x-text="formErrors.deliveryOther" class="form-error mt-1"></p>
                            </div>

                            <!-- Client Location (inline below delivery) -->
                            <div class="mt-2">
                                <label class="form-label">
                                    Client Location
                                </label>

                                <!-- Dropdown for In Person delivery -->
                                <template x-if="delivery === 'In Person'">
                                    <div>
                                        <select
                                            x-model="clientLocation"
                                            class="form-select"
                                            :class="{ 'border-danger-500': formErrors.clientLocation }"
                                            @blur="formErrors.clientLocation = validateProgressNoteField('clientLocation')"
                                            @change="clearFormError('clientLocation'); clientLocationOther = ''; clearFormError('clientLocationOther')"
                                        >
                                            <option value="Office">Office</option>
                                            <option value="Walk and talk">Walk and talk</option>
                                            <option value="Other">Other</option>
                                        </select>
                                        <p x-show="formErrors.clientLocation" x-text="formErrors.clientLocation" class="form-error mt-1"></p>

                                        <!-- Location "Other" text input -->
                                        <div x-show="clientLocation === 'Other'" x-transition class="mt-2">
                                            <input
                                                type="text"
                                                x-model="clientLocationOther"
                                                class="form-input"
                                                :class="{ 'border-danger-500': formErrors.clientLocationOther }"
                                                @blur="formErrors.clientLocationOther = validateProgressNoteField('clientLocationOther')"
                                                @input="clearFormError('clientLocationOther')"
                                                placeholder="Describe location and provide address..."
                                            >
                                            <p x-show="formErrors.clientLocationOther" x-text="formErrors.clientLocationOther" class="form-error mt-1"></p>
                                        </div>
                                    </div>
                                </template>

                                <!-- Dropdown for Video/Phone delivery -->
                                <template x-if="delivery === 'Video' || delivery === 'Phone'">
                                    <div>
                                        <select
                                            x-model="clientLocation"
                                            class="form-select"
                                            :class="{ 'border-danger-500': formErrors.clientLocation }"
                                            @blur="formErrors.clientLocation = validateProgressNoteField('clientLocation')"
                                            @change="handleClientLocationChange()"
                                        >
                                            <option value="Client's home">Client's home</option>
                                            <option value="Client's workplace">Client's workplace</option>
                                            <option value="Other">Other</option>
                                        </select>
                                        <p x-show="formErrors.clientLocation" x-text="formErrors.clientLocation" class="form-error mt-1"></p>

                                        <!-- Address/location details text input -->
                                        <div class="mt-2">
                                            <input
                                                type="text"
                                                x-model="clientLocationOther"
                                                class="form-input"
                                                :class="{ 'border-danger-500': formErrors.clientLocationOther }"
                                                @blur="formErrors.clientLocationOther = validateProgressNoteField('clientLocationOther')"
                                                @input="clearFormError('clientLocationOther')"
                                                :placeholder="getClientLocationPlaceholder()"
                                            >
                                            <p x-show="formErrors.clientLocationOther" x-text="formErrors.clientLocationOther" class="form-error mt-1"></p>
                                        </div>
                                    </div>
                                </template>

                                <!-- Text input for "Other" delivery type (freeform location) -->
                                <template x-if="delivery === 'Other'">
                                    <div>
                                        <input
                                            type="text"
                                            x-model="clientLocation"
                                            class="form-input"
                                            :class="{ 'border-danger-500': formErrors.clientLocation }"
                                            @blur="formErrors.clientLocation = validateProgressNoteField('clientLocation')"
                                            @input="clearFormError('clientLocation')"
                                            placeholder="Where is the client?"
                                        >
                                        <p x-show="formErrors.clientLocation" x-text="formErrors.clientLocation" class="form-error mt-1"></p>
                                    </div>
                                </template>
                            </div>
                        </div>

                        <!-- ========================================
                             SECTION 1: PURPOSE OF SESSION
                             ======================================== -->
                        <div class="border-t border-neutral-200 pt-4">
                            <h3 class="text-lg font-semibold text-neutral-700 mb-3">Purpose of Session</h3>

                            <div class="form-group">
                                <input
                                    type="text"
                                    id="session-purpose"
                                    x-model="currentNote.purpose"
                                    class="form-input"
                                    placeholder="e.g., Processing grief, Building coping skills, Identifying triggers"
                                >
                            </div>
                        </div>

                        <!-- ========================================
                             SECTION 2: MENTAL STATUS EXAM
                             ======================================== -->
                        <div class="border-t border-neutral-200 pt-4">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center gap-3">
                                    <h3 class="text-lg font-semibold text-neutral-700">Mental Status Exam</h3>
                                    <!-- Quick/Detailed Toggle -->
                                    <div class="segmented-control">
                                        <button
                                            type="button"
                                            class="segmented-control-option"
                                            :class="{ 'active': mseQuickMode }"
                                            @click="mseQuickMode = true"
                                        >
                                            <svg class="icon icon-sm"><use href="./assets/icons/tabler-sprites.svg#mode-quick"></use></svg>
                                            Quick
                                        </button>
                                        <button
                                            type="button"
                                            class="segmented-control-option"
                                            :class="{ 'active': !mseQuickMode }"
                                            @click="mseQuickMode = false"
                                        >
                                            <svg class="icon icon-sm"><use href="./assets/icons/tabler-sprites.svg#mode-detailed"></use></svg>
                                            Detailed
                                        </button>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button
                                        type="button"
                                        @click="addMSE()"
                                        class="btn btn-secondary text-sm"
                                    >
                                        <svg class="icon icon-md mr-1"><use href="./assets/icons/tabler-sprites.svg#action-add"></use></svg> Add MSE
                                    </button>
                                </div>
                            </div>

                            <!-- Empty state -->
                            <div x-show="currentNote.mseEntries.length === 0" class="text-sm text-neutral-500 italic py-4 text-center">
                                No Mental Status Exam entries. Click "Add MSE" to add one.
                            </div>

                            <!-- MSE Entries -->
                            <template x-for="(mse, mseIndex) in currentNote.mseEntries" :key="mse.id">
                                <div class="bg-neutral-50 rounded-lg p-4 mb-4 border border-neutral-200">
                                    <!-- MSE Header with Name Input and Delete -->
                                    <div class="flex items-center justify-between mb-3 gap-3">
                                        <div class="flex items-center gap-2 flex-1">
                                            <h4 class="text-base font-medium text-neutral-700 shrink-0">
                                                MSE <span x-text="mseIndex + 1"></span>
                                            </h4>
                                            <input
                                                type="text"
                                                x-model="mse.name"
                                                class="form-input py-1 px-2 text-sm flex-1 max-w-48"
                                                placeholder="Individual name..."
                                            >
                                        </div>
                                        <button
                                            type="button"
                                            @click="removeMSE(mse.id)"
                                            class="text-danger-500 hover:text-danger-700 p-2"
                                            title="Delete MSE"
                                        >
                                            <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-delete"></use></svg>
                                        </button>
                                    </div>

                                    <!-- MSE Note -->
                                    <div class="form-group mb-4">
                                        <label class="form-label">Note</label>
                                        <input
                                            type="text"
                                            x-model="mse.note"
                                            class="form-input"
                                            placeholder="Brief note about mental status..."
                                        >
                                    </div>

                                    <!-- Disturbance (detailed mode only) -->
                                    <div x-show="!mseQuickMode" x-transition class="form-group mb-4">
                                        <label class="form-label">Disturbance</label>
                                        <div class="btn-checkbox-group">
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.disturbance.includes('appetite') }"
                                                @click="toggleCheckbox(mse.disturbance, 'appetite')">
                                                <svg class="icon icon-md"><use :href="mse.disturbance.includes('appetite') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Appetite
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.disturbance.includes('sleep') }"
                                                @click="toggleCheckbox(mse.disturbance, 'sleep')">
                                                <svg class="icon icon-md"><use :href="mse.disturbance.includes('sleep') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Sleep
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.disturbance.includes('medication-compliance') }"
                                                @click="toggleCheckbox(mse.disturbance, 'medication-compliance')">
                                                <svg class="icon icon-md"><use :href="mse.disturbance.includes('medication-compliance') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Medication Compliance
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.disturbance.includes('other') }"
                                                @click="toggleCheckbox(mse.disturbance, 'other')">
                                                <svg class="icon icon-md"><use :href="mse.disturbance.includes('other') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Other
                                            </button>
                                        </div>
                                        <input
                                            x-show="mse.disturbance.includes('other')"
                                            x-transition
                                            type="text"
                                            x-model="mse.disturbanceOther"
                                            class="form-input mt-2"
                                            placeholder="Describe 'Other'..."
                                        >
                                    </div>

                                    <!-- Mood (shown in both quick and detailed modes) -->
                                    <div class="form-group mb-4">
                                        <label class="form-label">Mood</label>
                                        <div class="btn-checkbox-group">
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('angry') }"
                                                @click="toggleCheckbox(mse.mood, 'angry')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('angry') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Angry
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('anxious') }"
                                                @click="toggleCheckbox(mse.mood, 'anxious')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('anxious') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Anxious
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('dysphoric') }"
                                                @click="toggleCheckbox(mse.mood, 'dysphoric')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('dysphoric') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Dysphoric
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('depressed') }"
                                                @click="toggleCheckbox(mse.mood, 'depressed')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('depressed') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Depressed
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('euphoric') }"
                                                @click="toggleCheckbox(mse.mood, 'euphoric')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('euphoric') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Euphoric
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('fearful') }"
                                                @click="toggleCheckbox(mse.mood, 'fearful')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('fearful') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Fearful
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('guilty') }"
                                                @click="toggleCheckbox(mse.mood, 'guilty')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('guilty') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Guilty
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('irritable') }"
                                                @click="toggleCheckbox(mse.mood, 'irritable')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('irritable') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Irritable
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('joyful') }"
                                                @click="toggleCheckbox(mse.mood, 'joyful')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('joyful') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Joyful
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.mood.includes('other') }"
                                                @click="toggleCheckbox(mse.mood, 'other')">
                                                <svg class="icon icon-md"><use :href="mse.mood.includes('other') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Other
                                            </button>
                                        </div>
                                        <input
                                            x-show="mse.mood.includes('other')"
                                            x-transition
                                            type="text"
                                            x-model="mse.moodOther"
                                            class="form-input mt-2"
                                            placeholder="Describe 'Other'..."
                                        >
                                    </div>

                                    <!-- Perception (detailed mode only) -->
                                    <div x-show="!mseQuickMode" x-transition class="form-group mb-4">
                                        <label class="form-label">Perception</label>
                                        <div class="btn-checkbox-group">
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.perception.includes('hallucinations') }"
                                                @click="toggleCheckbox(mse.perception, 'hallucinations')">
                                                <svg class="icon icon-md"><use :href="mse.perception.includes('hallucinations') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Hallucinations
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.perception.includes('depersonalization') }"
                                                @click="toggleCheckbox(mse.perception, 'depersonalization')">
                                                <svg class="icon icon-md"><use :href="mse.perception.includes('depersonalization') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Depersonalization
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.perception.includes('derealization') }"
                                                @click="toggleCheckbox(mse.perception, 'derealization')">
                                                <svg class="icon icon-md"><use :href="mse.perception.includes('derealization') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Derealization
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.perception.includes('other') }"
                                                @click="toggleCheckbox(mse.perception, 'other')">
                                                <svg class="icon icon-md"><use :href="mse.perception.includes('other') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Other
                                            </button>
                                        </div>
                                        <input
                                            x-show="mse.perception.includes('other')"
                                            x-transition
                                            type="text"
                                            x-model="mse.perceptionOther"
                                            class="form-input mt-2"
                                            placeholder="Describe 'Other'..."
                                        >
                                    </div>

                                    <!-- Thought Content (detailed mode only) -->
                                    <div x-show="!mseQuickMode" x-transition class="form-group mb-4">
                                        <label class="form-label">Thought Content</label>
                                        <div class="btn-checkbox-group">
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtContent.includes('delusions') }"
                                                @click="toggleCheckbox(mse.thoughtContent, 'delusions')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtContent.includes('delusions') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Delusions
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtContent.includes('phobias') }"
                                                @click="toggleCheckbox(mse.thoughtContent, 'phobias')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtContent.includes('phobias') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Phobias
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtContent.includes('obsessions') }"
                                                @click="toggleCheckbox(mse.thoughtContent, 'obsessions')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtContent.includes('obsessions') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Obsessions
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtContent.includes('magical-thinking') }"
                                                @click="toggleCheckbox(mse.thoughtContent, 'magical-thinking')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtContent.includes('magical-thinking') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Magical Thinking
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtContent.includes('other') }"
                                                @click="toggleCheckbox(mse.thoughtContent, 'other')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtContent.includes('other') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Other
                                            </button>
                                        </div>
                                        <input
                                            x-show="mse.thoughtContent.includes('other')"
                                            x-transition
                                            type="text"
                                            x-model="mse.thoughtContentOther"
                                            class="form-input mt-2"
                                            placeholder="Describe 'Other'..."
                                        >
                                    </div>

                                    <!-- Thought Process (detailed mode only) -->
                                    <div x-show="!mseQuickMode" x-transition class="form-group mb-4">
                                        <label class="form-label">Thought Process</label>
                                        <div class="btn-checkbox-group">
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtProcess.includes('circumstantial') }"
                                                @click="toggleCheckbox(mse.thoughtProcess, 'circumstantial')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtProcess.includes('circumstantial') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Circumstantial
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtProcess.includes('tangential') }"
                                                @click="toggleCheckbox(mse.thoughtProcess, 'tangential')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtProcess.includes('tangential') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Tangential
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtProcess.includes('loose-associations') }"
                                                @click="toggleCheckbox(mse.thoughtProcess, 'loose-associations')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtProcess.includes('loose-associations') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Loose Associations
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtProcess.includes('flight-of-ideas') }"
                                                @click="toggleCheckbox(mse.thoughtProcess, 'flight-of-ideas')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtProcess.includes('flight-of-ideas') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Flight of Ideas
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtProcess.includes('thought-blocking') }"
                                                @click="toggleCheckbox(mse.thoughtProcess, 'thought-blocking')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtProcess.includes('thought-blocking') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Thought Blocking
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.thoughtProcess.includes('other') }"
                                                @click="toggleCheckbox(mse.thoughtProcess, 'other')">
                                                <svg class="icon icon-md"><use :href="mse.thoughtProcess.includes('other') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Other
                                            </button>
                                        </div>
                                        <input
                                            x-show="mse.thoughtProcess.includes('other')"
                                            x-transition
                                            type="text"
                                            x-model="mse.thoughtProcessOther"
                                            class="form-input mt-2"
                                            placeholder="Describe 'Other'..."
                                        >
                                    </div>

                                    <!-- Risk (shown in both quick and detailed modes) -->
                                    <div class="form-group mb-4">
                                        <label class="form-label">Risk</label>
                                        <div class="btn-checkbox-group">
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.risk.includes('none') }"
                                                @click="toggleRiskCheckbox(mse, 'none')">
                                                <svg class="icon icon-md"><use :href="mse.risk.includes('none') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                None
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.risk.includes('self-harm') }"
                                                @click="toggleRiskCheckbox(mse, 'self-harm')">
                                                <svg class="icon icon-md"><use :href="mse.risk.includes('self-harm') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Self-harm
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.risk.includes('suicidal-ideation') }"
                                                @click="toggleRiskCheckbox(mse, 'suicidal-ideation')">
                                                <svg class="icon icon-md"><use :href="mse.risk.includes('suicidal-ideation') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Suicidal Ideation
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.risk.includes('homicidal-ideation') }"
                                                @click="toggleRiskCheckbox(mse, 'homicidal-ideation')">
                                                <svg class="icon icon-md"><use :href="mse.risk.includes('homicidal-ideation') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Homicidal Ideation
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.risk.includes('exploitation') }"
                                                @click="toggleRiskCheckbox(mse, 'exploitation')">
                                                <svg class="icon icon-md"><use :href="mse.risk.includes('exploitation') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Exploitation
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.risk.includes('substance-use-dependence') }"
                                                @click="toggleRiskCheckbox(mse, 'substance-use-dependence')">
                                                <svg class="icon icon-md"><use :href="mse.risk.includes('substance-use-dependence') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Substance Use/Dependence
                                            </button>
                                            <button type="button" class="btn-checkbox"
                                                :class="{ 'checked': mse.risk.includes('other') }"
                                                @click="toggleRiskCheckbox(mse, 'other')">
                                                <svg class="icon icon-md"><use :href="mse.risk.includes('other') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                                Other
                                            </button>
                                        </div>
                                        <!-- Risk Details (shows when risk factors selected, excluding "none" and "other"-only) -->
                                        <textarea
                                            x-show="mse.risk.length > 0 && !mse.risk.includes('none') && !(mse.risk.length === 1 && mse.risk.includes('other'))"
                                            x-transition
                                            x-model="mse.riskDetails"
                                            class="form-textarea mt-2"
                                            rows="2"
                                            placeholder="Provide details about risk assessment (e.g., passive ideation with no plan or means)..."
                                        ></textarea>
                                        <!-- Other description (shows when "other" is selected) -->
                                        <input
                                            x-show="mse.risk.includes('other')"
                                            x-transition
                                            type="text"
                                            x-model="mse.riskOther"
                                            class="form-input mt-2"
                                            placeholder="Describe 'Other'..."
                                        >
                                    </div>

                                </div>
                            </template>
                        </div>

                        <!-- ========================================
                             SECTION 3: INTERVENTIONS
                             ======================================== -->
                        <div class="border-t border-neutral-200 pt-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-lg font-semibold text-neutral-700">Interventions</h3>
                                <a href="interventions.html" class="btn btn-ghost text-sm">
                                    <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#settings"></use></svg>
                                    Manage
                                </a>
                            </div>

                            <!-- Selected Interventions (expandable chips) -->
                            <div x-show="currentNote.interventions.length > 0" class="mb-4">
                                <div class="text-xs font-semibold text-neutral-500 uppercase tracking-wide mb-2">
                                    Selected (<span x-text="currentNote.interventions.length"></span>)
                                </div>
                                <div class="flex flex-wrap gap-2">
                                    <template x-for="(intervention, index) in currentNote.interventions" :key="index">
                                        <div
                                            class="intervention-chip-expandable"
                                            :class="{ 'expanded': interventionSelector.expandedChip === index }"
                                            @click.outside="interventionSelector.expandedChip === index && (interventionSelector.expandedChip = null)"
                                        >
                                            <div
                                                class="chip-main"
                                                @click="toggleInterventionChipExpand(index)"
                                            >
                                                <!-- Custom intervention indicator -->
                                                <svg
                                                    x-show="intervention.isCustom"
                                                    x-cloak
                                                    class="icon icon-xs text-primary-500"
                                                    title="Custom intervention"
                                                ><use href="./assets/icons/tabler-sprites.svg#action-edit"></use></svg>
                                                <span x-text="intervention.label"></span>
                                                <span class="chip-indicators">
                                                    <svg
                                                        x-show="intervention.notes?.trim()"
                                                        class="icon icon-sm"
                                                        title="Has notes"
                                                    ><use href="./assets/icons/tabler-sprites.svg#has-description"></use></svg>
                                                </span>
                                                <svg class="icon icon-sm chip-expand-indicator"><use href="./assets/icons/tabler-sprites.svg#expand"></use></svg>
                                                <button
                                                    type="button"
                                                    class="chip-remove-btn"
                                                    @click.stop="removeIntervention(index)"
                                                    title="Remove intervention"
                                                >
                                                    <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                                                </button>
                                            </div>
                                            <div
                                                x-show="interventionSelector.expandedChip === index"
                                                x-transition:enter="transition ease-out duration-200"
                                                x-transition:enter-start="opacity-0"
                                                x-transition:enter-end="opacity-100"
                                                class="chip-details"
                                                @click.stop
                                            >
                                                <div class="form-group">
                                                    <label class="form-label text-xs">
                                                        Notes
                                                        <span class="text-neutral-500 font-normal">(optional)</span>
                                                    </label>
                                                    <textarea
                                                        class="form-textarea text-sm"
                                                        placeholder="How was this applied? Client's response? Any context to remember?"
                                                        x-model="intervention.notes"
                                                        rows="4"
                                                        x-effect="if (interventionSelector.expandedChip === index) $nextTick(() => $el.focus())"
                                                    ></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>

                            <!-- Intervention Selector Card -->
                            <div class="card p-4">
                                <!-- Search Input -->
                                <div class="intervention-search-container mb-4">
                                    <svg class="icon intervention-search-icon"><use href="./assets/icons/tabler-sprites.svg#search"></use></svg>
                                    <input
                                        type="text"
                                        class="form-input intervention-search-input"
                                        placeholder="Search by what you worked on (e.g., breathing, rapport, anxiety)..."
                                        x-model="interventionSelector.searchQuery"
                                        @input="searchInterventions()"
                                    >
                                </div>

                                <!-- Search Results -->
                                <div
                                    x-show="interventionSelector.searchQuery && getFilteredSearchResults().length > 0"
                                    class="intervention-results-container"
                                >
                                    <template x-for="intervention in getFilteredSearchResults()" :key="intervention.id">
                                        <button
                                            type="button"
                                            class="intervention-result"
                                            @click="addIntervention(intervention)"
                                            :disabled="isInterventionSelected(intervention)"
                                            :class="{ 'selected': isInterventionSelected(intervention) }"
                                        >
                                            <div>
                                                <div class="intervention-result-label" x-html="highlightInterventionMatch(intervention.label, interventionSelector.searchQuery)"></div>
                                                <div class="intervention-result-approaches">
                                                    <template x-for="approach in getVisibleApproachesForIntervention(intervention.approaches)" :key="approach">
                                                        <span class="approach-tag" x-text="getApproachName(approach)"></span>
                                                    </template>
                                                </div>
                                            </div>
                                            <svg x-show="isInterventionSelected(intervention)" class="icon icon-sm text-success-600"><use href="./assets/icons/tabler-sprites.svg#selected"></use></svg>
                                        </button>
                                    </template>
                                </div>

                                <!-- No Results -->
                                <div
                                    x-show="interventionSelector.searchQuery && getFilteredSearchResults().length === 0"
                                    class="text-center py-8 text-neutral-500"
                                >
                                    <svg class="icon icon-2xl text-neutral-300 mb-3"><use href="./assets/icons/tabler-sprites.svg#empty-no-results"></use></svg>
                                    <p>No interventions found for "<span x-text="interventionSelector.searchQuery"></span>"</p>
                                    <p class="text-sm mt-2">Try a different search term, or build a custom intervention below.</p>
                                </div>

                                <!-- Quick-Add Section (shown when not searching) -->
                                <div x-show="!interventionSelector.searchQuery" class="mb-6">
                                    <div class="quick-add-label">
                                        <svg class="icon icon-sm"><use href="./assets/icons/tabler-sprites.svg#mode-quick"></use></svg>
                                        Favorites & Frequently Used
                                    </div>
                                    <div class="quick-add-grid">
                                        <template x-for="intervention in getQuickAddInterventions()" :key="intervention.id">
                                            <button
                                                type="button"
                                                class="quick-add-btn"
                                                @click="addIntervention(intervention)"
                                                :disabled="isInterventionSelected(intervention)"
                                                :class="{ 'selected': isInterventionSelected(intervention) }"
                                            >
                                                <span class="quick-add-icons">
                                                    <svg x-show="interventionPreferences.favorites.includes(intervention.id)" x-cloak class="icon icon-xs"><use href="./assets/icons/tabler-sprites.svg#bookmarked"></use></svg>
                                                    <svg x-show="intervention._frequencySource === 'client'" x-cloak class="icon icon-xs"><use href="./assets/icons/tabler-sprites.svg#frequent-client"></use></svg>
                                                    <svg x-show="intervention._frequencySource === 'global'" x-cloak class="icon icon-xs"><use href="./assets/icons/custom-sprites.svg#frequent-clients"></use></svg>
                                                </span>
                                                <span class="verb" x-text="intervention.label.split(' ')[0]"></span>
                                                <span class="theme" x-text="intervention.label.split(' ').slice(1).join(' ')"></span>
                                                <svg x-show="isInterventionSelected(intervention)" class="icon icon-sm text-success-600 ml-1"><use href="./assets/icons/tabler-sprites.svg#selected"></use></svg>
                                            </button>
                                        </template>
                                    </div>
                                </div>

                                <!-- Browse All Section -->
                                <div x-show="!interventionSelector.searchQuery">
                                    <div class="browse-header mt-6">
                                        <button
                                            type="button"
                                            class="browse-toggle"
                                            :class="{ 'expanded': interventionSelector.showBrowse }"
                                            @click="interventionSelector.showBrowse = !interventionSelector.showBrowse"
                                        >
                                            <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#expand"></use></svg>
                                            <span x-text="interventionSelector.showBrowse ? 'Hide all interventions' : 'Show all interventions'"></span>
                                            <span class="result-count">(<span x-text="getFilteredBrowseResults().length"></span> interventions)</span>
                                        </button>
                                    </div>

                                    <!-- Filter Tabs and Sort Toggle (shown when browsing all interventions) -->
                                    <div
                                        class="flex items-center justify-between gap-4 mt-3"
                                        x-show="interventionSelector.showBrowse"
                                    >
                                        <div class="intervention-filter-tabs">
                                            <button
                                                type="button"
                                                class="filter-tab"
                                                :class="{ 'active': interventionSelector.activeFilter === 'all' }"
                                                @click="interventionSelector.activeFilter = 'all'"
                                            >
                                                All
                                            </button>
                                            <template x-for="approach in therapeuticApproachOptions" :key="approach.value">
                                                <button
                                                    type="button"
                                                    class="filter-tab"
                                                    :class="{ 'active': interventionSelector.activeFilter === approach.value }"
                                                    @click="interventionSelector.activeFilter = approach.value"
                                                    x-text="approach.name"
                                                ></button>
                                            </template>
                                        </div>
                                        <!-- Sort by Usage Toggle -->
                                        <button
                                            type="button"
                                            @click="sortByUsage = !sortByUsage"
                                            class="btn btn-ghost flex items-center gap-2 flex-shrink-0"
                                            title="Sort by favorites and usage"
                                        >
                                            <span class="text-sm">Sort by usage</span>
                                            <svg x-show="sortByUsage" class="icon icon-lg text-primary-500">
                                                <use href="./assets/icons/tabler-sprites.svg#setting-toggle-on"></use>
                                            </svg>
                                            <svg x-show="!sortByUsage" x-cloak class="icon icon-lg text-neutral-400">
                                                <use href="./assets/icons/tabler-sprites.svg#setting-toggle-off"></use>
                                            </svg>
                                        </button>
                                    </div>

                                    <div x-show="interventionSelector.showBrowse" class="intervention-results-container" style="max-height: 400px;">
                                        <template x-for="intervention in getSortedBrowseResults()" :key="intervention.id">
                                            <button
                                                type="button"
                                                class="intervention-result"
                                                @click="addIntervention(intervention)"
                                                :disabled="isInterventionSelected(intervention)"
                                                :class="{ 'selected': isInterventionSelected(intervention) }"
                                            >
                                                <div>
                                                    <div class="flex items-center gap-2">
                                                        <div class="intervention-result-label" x-text="intervention.label"></div>
                                                        <svg x-show="isInterventionSelected(intervention)" class="icon icon-sm text-success-600 flex-shrink-0"><use href="./assets/icons/tabler-sprites.svg#selected"></use></svg>
                                                    </div>
                                                    <div class="intervention-result-approaches">
                                                        <template x-for="approach in getVisibleApproachesForIntervention(intervention.approaches)" :key="approach">
                                                            <span class="approach-tag" x-text="getApproachName(approach)"></span>
                                                        </template>
                                                    </div>
                                                </div>
                                            </button>
                                        </template>
                                    </div>
                                </div>

                                <!-- Write Custom Intervention -->
                                <div class="mt-4">
                                    <!-- Button mode: Show when NOT in writing mode -->
                                    <button
                                        type="button"
                                        class="build-custom-btn"
                                        @click="startCustomIntervention()"
                                        x-show="!interventionSelector.isWritingCustom"
                                    >
                                        <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-add"></use></svg>
                                        Write custom intervention
                                    </button>

                                    <!-- Input mode: Show when in writing mode -->
                                    <div
                                        x-show="interventionSelector.isWritingCustom"
                                        x-cloak
                                        x-transition
                                        class="custom-intervention-input-container"
                                    >
                                        <div class="flex gap-2 items-center">
                                            <svg class="icon icon-sm text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#action-edit"></use></svg>
                                            <input
                                                type="text"
                                                x-ref="customInterventionInput"
                                                x-model="interventionSelector.customInterventionLabel"
                                                @keydown.enter.prevent="addCustomIntervention()"
                                                @keydown.escape.prevent="cancelCustomIntervention()"
                                                class="form-input flex-1"
                                                placeholder="Type intervention name and press Enter..."
                                            >
                                            <button
                                                type="button"
                                                class="btn btn-primary btn-sm"
                                                @click="addCustomIntervention()"
                                                :disabled="!interventionSelector.customInterventionLabel.trim()"
                                            >
                                                Add
                                            </button>
                                            <button
                                                type="button"
                                                class="btn btn-ghost btn-sm"
                                                @click="cancelCustomIntervention()"
                                            >
                                                Cancel
                                            </button>
                                        </div>
                                        <p class="text-xs text-neutral-500 mt-2 pl-7">
                                            Press Enter to add, Escape to cancel. Saved with this note only.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Response to Interventions (General) -->
                            <div class="form-group mt-4">
                                <label class="form-label">Response to Interventions</label>
                                <textarea
                                    x-model="currentNote.responseToInterventions"
                                    class="form-textarea"
                                    rows="3"
                                    placeholder="How did the client generally respond to today's interventions? (e.g., engaged openly, expressed relief, gained insight...)"
                                ></textarea>
                            </div>
                        </div>

                        <!-- ========================================
                             SECTION 4: THERAPEUTIC APPROACHES
                             ======================================== -->
                        <div class="border-t border-neutral-200 pt-4">
                            <h3 class="text-lg font-semibold text-neutral-700 mb-3">Therapeutic Approaches</h3>

                            <div class="form-group">
                                <div class="btn-checkbox-group">
                                    <!-- Dynamic approaches from constants, ordered with recommended first -->
                                    <template x-for="approach in getOrderedApproaches()" :key="approach.value">
                                        <button type="button" class="btn-checkbox"
                                            :class="{
                                                'checked': currentNote.therapeuticApproaches.includes(approach.value),
                                                'recommended': isApproachRecommended(approach.value)
                                            }"
                                            @click="toggleCheckbox(currentNote.therapeuticApproaches, approach.value)">
                                            <svg class="icon icon-md"><use :href="currentNote.therapeuticApproaches.includes(approach.value) ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                            <span x-text="approach.name"></span>
                                            <svg x-show="isApproachRecommended(approach.value)" class="icon icon-sm recommended-icon" title="Recommended based on interventions"><use href="./assets/icons/tabler-sprites.svg#recommended"></use></svg>
                                        </button>
                                    </template>
                                    <!-- Other option (handled separately) -->
                                    <button type="button" class="btn-checkbox"
                                        :class="{ 'checked': currentNote.therapeuticApproaches.includes('other-therapy') }"
                                        @click="toggleCheckbox(currentNote.therapeuticApproaches, 'other-therapy')">
                                        <svg class="icon icon-md"><use :href="currentNote.therapeuticApproaches.includes('other-therapy') ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                        Other
                                    </button>
                                </div>
                                <input
                                    x-show="currentNote.therapeuticApproaches.includes('other-therapy')"
                                    x-transition
                                    type="text"
                                    x-model="currentNote.therapeuticApproachesOther"
                                    class="form-input mt-2"
                                    placeholder="Describe the 'other' therapeutic approach..."
                                >
                            </div>
                        </div>

                        <!-- ========================================
                             SECTION 5: ADDITIONAL NOTES
                             ======================================== -->
                        <div class="border-t border-neutral-200 pt-4">
                            <h3 class="text-lg font-semibold text-neutral-700 mb-3">Additional Notes</h3>

                            <div class="form-group">
                                <label class="form-label" for="additional-notes">Additional Session Notes</label>
                                <textarea
                                    id="additional-notes"
                                    x-model="currentNote.additionalNotes"
                                    class="form-textarea"
                                    rows="4"
                                    placeholder="Any additional observations, notes, or details about this session..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- ========================================
                             SECTION 6: FUTURE
                             ======================================== -->
                        <div class="border-t border-neutral-200 pt-4">
                            <h3 class="text-lg font-semibold text-neutral-700 mb-3">Future</h3>

                            <div class="form-group">
                                <label class="form-label" for="future-notes">Notes for Next Session</label>
                                <textarea
                                    id="future-notes"
                                    x-model="currentNote.futureNotes"
                                    class="form-textarea"
                                    rows="4"
                                    placeholder="Homework assigned, action items, topics to revisit, goals for next session..."
                                ></textarea>
                            </div>
                        </div>

                        <!-- ========================================
                             SECTION 7: NARRATIVE FORMAT
                             ======================================== -->
                        <div class="border-t border-neutral-200 pt-4">
                            <!-- Header row: Title/description on left, button on right -->
                            <div class="flex items-start justify-between mb-3">
                                <div>
                                    <h3 class="text-lg font-semibold text-neutral-700">Narrative Format</h3>
                                    <p class="text-sm text-neutral-500">
                                        Write or generate a prose version of this progress note.
                                    </p>
                                </div>
                                <!-- Button group for Generate/Reset -->
                                <div x-show="!isSupervisor && !generatingNarrative" class="flex gap-2 shrink-0 ml-4">
                                    <!-- Reset button (shown when there's content to clear) -->
                                    <button
                                        x-show="currentNote.narrativeFormat || lastNarrativeThinking"
                                        x-cloak
                                        type="button"
                                        @click="resetNarrative()"
                                        class="btn btn-ghost"
                                        title="Clear narrative and thinking"
                                    >
                                        <span class="flex items-center">
                                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#action-reset"></use></svg>
                                            Reset
                                        </span>
                                    </button>

                                    <!-- Generate button -->
                                    <button
                                        type="button"
                                        @click="generateNarrative()"
                                        :disabled="!selectedClient"
                                        class="btn btn-primary"
                                        :class="{ 'opacity-50 cursor-not-allowed': !selectedClient }"
                                    >
                                        <span x-show="selectedClient" class="flex items-center">
                                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#ai-generate"></use></svg>
                                            Generate
                                        </span>
                                        <span x-show="!selectedClient" class="flex items-center">
                                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#ai-generate"></use></svg>
                                            Select Client to Generate Narrative
                                        </span>
                                    </button>
                                </div>

                                <!-- Stop button (shown while generating) -->
                                <button
                                    x-show="!isSupervisor && generatingNarrative"
                                    type="button"
                                    @click="stopNarrativeGeneration()"
                                    class="btn btn-danger shrink-0 ml-4"
                                >
                                    <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#ai-stop"></use></svg>
                                    Stop
                                </button>
                            </div>

                            <!-- Error Message -->
                            <div
                                x-show="narrativeError"
                                x-transition
                                class="alert-error mb-3"
                            >
                                <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                                <span x-text="narrativeError"></span>
                            </div>

                            <div class="form-group">
                                <div class="flex items-center justify-between mb-1">
                                    <div>
                                        <label class="form-label mb-0" for="narrative-format">Narrative Progress Note</label>
                                        <p class="text-xs text-neutral-500">
                                            AI-generated content will be appended to any existing text. You can edit the result or generate multiple versions.
                                        </p>
                                    </div>

                                    <!-- Include Future Plans Toggle -->
                                    <button
                                        type="button"
                                        @click="canToggleFutureNotes && (includeFutureNotes = !includeFutureNotes)"
                                        class="btn btn-ghost flex items-center gap-2"
                                        :class="!canToggleFutureNotes && 'opacity-50 cursor-not-allowed'"
                                        :title="canToggleFutureNotes
                                            ? 'Toggle whether to include future session plans in the generated narrative'
                                            : 'Add content to Notes for Next Session to enable this option'"
                                    >
                                        <span class="text-sm">Include plans</span>
                                        <svg
                                            x-show="effectiveIncludeFutureNotes"
                                            class="icon icon-lg text-primary-500"
                                        ><use href="./assets/icons/tabler-sprites.svg#setting-toggle-on"></use></svg>
                                        <svg
                                            x-show="!effectiveIncludeFutureNotes"
                                            x-cloak
                                            class="icon icon-lg text-neutral-400"
                                        ><use href="./assets/icons/tabler-sprites.svg#setting-toggle-off"></use></svg>
                                    </button>
                                </div>

                                <!-- Wrapper to prevent form-group gap between thinking section and textarea -->
                                <div>
                                    <!-- AI Thinking Section (collapsible) - shows below header -->
                                    <div
                                        x-show="lastNarrativeThinking"
                                        class="border border-neutral-200 rounded-t-lg overflow-hidden"
                                    >
                                        <button
                                            type="button"
                                            @click="showNarrativeThinking = !showNarrativeThinking"
                                            class="w-full flex items-center justify-between px-4 py-3 bg-neutral-50 hover:bg-neutral-100 transition-colors text-left"
                                        >
                                            <span class="flex items-center text-sm font-medium text-neutral-600">
                                                <thinking-spinner x-show="isThinkingPhase" class="icon-sm mr-2 text-primary-500"></thinking-spinner>
                                                <svg x-show="!isThinkingPhase" x-cloak class="icon icon-sm mr-2 text-primary-500"><use href="./assets/icons/tabler-sprites.svg#ai-thinking"></use></svg>
                                                Thinking
                                                <span class="ml-2 text-xs font-normal text-neutral-500" x-text="isThinkingPhase ? '(in progress...)' : '(most recent generation)'"></span>
                                            </span>
                                            <svg
                                                class="icon icon-sm text-neutral-400 transition-transform duration-200"
                                                :class="{ 'rotate-180': showNarrativeThinking }"
                                            ><use href="./assets/icons/tabler-sprites.svg#expand"></use></svg>
                                        </button>
                                        <div
                                            x-show="showNarrativeThinking"
                                            class="px-4 py-3 bg-white border-t border-neutral-300"
                                        >
                                            <p class="text-xs text-neutral-500 mb-2">
                                                This shows the AI's reasoning process. It is not saved with your note.
                                            </p>
                                            <div class="text-sm text-neutral-700 whitespace-pre-wrap" x-text="lastNarrativeThinking"></div>
                                        </div>
                                    </div>

                                    <textarea
                                        id="narrative-format"
                                        x-model="currentNote.narrativeFormat"
                                        class="form-textarea"
                                        :class="{ 'rounded-t-none border-t-0': lastNarrativeThinking }"
                                        rows="8"
                                        placeholder="Type your narrative here, or click 'Generate Narrative' to have AI create one based on your structured note data..."
                                    ></textarea>
                                </div>
                            </div>
                        </div>

                        <div x-show="!isSupervisor" class="flex justify-between items-center pt-2 border-t border-neutral-200 mt-4">
                            <button
                                type="button"
                                @click="clearForm"
                                class="btn btn-secondary"
                            >
                                <span class="flex items-center">
                                    <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#action-reset"></use></svg>
                                    Clear
                                </span>
                            </button>

                            <button
                                type="submit"
                                class="btn btn-primary"
                                :disabled="!selectedClient || submitting"
                            >
                                <span x-show="!submitting" class="flex items-center">
                                    <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#action-submit"></use></svg>
                                    Submit Note
                                </span>
                                <span x-show="submitting" class="flex items-center">
                                    <blob-spinner class="mr-2"></blob-spinner>
                                    Submitting...
                                </span>
                            </button>
                        </div>
                    </form>

                </div>
            </main>
            </template>

            <!-- Toast Notifications (bottom center for consistency) -->
            <div class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 space-y-2">
                <!-- Success Toast -->
                <div
                    x-show="showSuccessToast"
                    x-transition
                    x-cloak
                    class="alert-success shadow-lg min-w-[300px]"
                >
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <span>Note saved successfully!</span>
                    </div>
                </div>

                <!-- Error Toast -->
                <div
                    x-show="showErrorToast"
                    x-transition
                    x-cloak
                    class="alert-error shadow-lg min-w-[300px]"
                >
                    <div class="flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                      </svg>
                      <span x-text="errorMessage"></span>
                    </div>
                </div>

            </div>

            <!-- Undo Toast (bottom center, Material Design snackbar style) -->
            <div class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50">
                <div
                    x-show="undoToast.visible"
                    x-transition
                    x-cloak
                    class="bg-neutral-800 text-white shadow-lg min-w-[300px] rounded-lg p-3"
                >
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex items-center gap-2">
                            <svg class="icon icon-sm text-neutral-400"><use href="./assets/icons/tabler-sprites.svg#action-delete"></use></svg>
                            <span x-text="undoToast.message"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button
                                type="button"
                                @click="handleUndo()"
                                class="text-primary-300 hover:text-primary-200 font-medium text-sm"
                            >
                                Undo
                            </button>
                            <button
                                type="button"
                                @click="dismissUndoToast()"
                                class="text-neutral-400 hover:text-neutral-300"
                            >
                                <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Floating Quick Notes Button -->
            <div
                x-data="{ expanded: false }"
                class="fixed bottom-6 right-6 z-40"
                x-show="selectedClient && entryView === 'workspace' && formType === 'Progress Note'"
                x-cloak
            >
                <!-- Expanded Panel -->
                <div
                    x-show="expanded"
                    @click.outside="expanded = false"
                    x-transition:enter="transition ease-out duration-200"
                    x-transition:enter-start="opacity-0 translate-y-4"
                    x-transition:enter-end="opacity-100 translate-y-0"
                    x-transition:leave="transition ease-in duration-150"
                    x-transition:leave-start="opacity-100 translate-y-0"
                    x-transition:leave-end="opacity-0 translate-y-4"
                    class="absolute bottom-16 right-0 w-100 bg-white rounded-lg shadow-xl border border-neutral-200 overflow-hidden"
                >
                    <div class="bg-neutral-50 px-4 py-2 border-b border-neutral-200 flex items-center justify-between">
                        <span class="text-sm font-medium text-neutral-700">
                            <svg class="icon icon-sm mr-1.5 text-neutral-500 inline-block"><use href="./assets/icons/tabler-sprites.svg#action-edit"></use></svg>
                            Quick Notes
                        </span>
                        <button
                            type="button"
                            @click="expanded = false"
                            class="text-neutral-400 hover:text-neutral-600 p-1"
                        >
                            <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#close"></use></svg>
                        </button>
                    </div>
                    <div class="p-4">
                        <textarea
                            x-model="currentNote.additionalNotes"
                            class="form-textarea w-full h-60 text-sm"
                            placeholder="Capture quick notes during session..."
                        ></textarea>
                        <p class="text-xs text-neutral-400 mt-2">
                            <svg class="icon icon-xs mr-1 inline-block"><use href="./assets/icons/tabler-sprites.svg#info"></use></svg>
                            Syncs with Additional Notes section in the form
                        </p>
                    </div>
                </div>

                <!-- Floating Button -->
                <button
                    type="button"
                    @click="expanded = !expanded"
                    class="btn-fab"
                    :class="{ 'ring-2 ring-primary-300 ring-offset-2': expanded }"
                    title="Quick Notes"
                >
                    <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-edit"></use></svg>
                </button>
            </div>

    </div>

    <!-- Application logic is in js/app.js -->
</body>
</html>
