<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Therapy Docs</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Critical CSS to prevent FOUC -->
    <style>[x-cloak] { display: none !important; }</style>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="dist/output.css">

    <!-- QR Code Generator (client-side, no external requests) -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

    <!-- Application Entry Point (ES Module) - includes Alpine.js -->
    <script type="module" src="js/entries/login.entry.js"></script>
</head>
<body class="auth-bg">
    <div x-data="loginApp">

        <!-- ========================================
             LOGIN SCREEN
             ======================================== -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md">
                <div class="card auth-card">
                    <!-- Brand Header (only on login step) -->
                    <div x-show="!showMFA && !newPasswordRequired" class="text-center mb-6">
                        <div class="icon-badge-lg bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="icon icon-2xl text-primary-600"><use href="./assets/icons/tabler-sprites.svg#therapy-docs-app"></use></svg>
                        </div>
                        <h1 class="text-3xl font-bold text-neutral-900">Therapy Docs</h1>
                        <p class="text-sm text-neutral-500 mt-2">Secure clinical documentation</p>
                    </div>

                    <!-- Error Message -->
                    <div x-show="errorMessage" x-transition x-cloak class="alert-error mb-4">
                        <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                        <span x-text="errorMessage"></span>
                    </div>

                    <!-- Login Form -->
                    <form x-show="!showMFA && !newPasswordRequired" @submit.prevent="login" class="space-y-4">
                        <div class="form-group mb-4" x-data="{ focused: false }">
                            <label class="form-label" for="email">Email</label>
                            <div class="input-with-icon">
                                <svg class="icon input-icon" :class="{ 'focused': focused }"><use href="./assets/icons/tabler-sprites.svg#security-email"></use></svg>
                                <input
                                    type="email"
                                    id="email"
                                    x-model="credentials.email"
                                    @focus="focused = true"
                                    @blur="focused = false"
                                    class="form-input"
                                    style="padding-left: 2.5rem;"
                                    placeholder="user@example.com"
                                    autocomplete="email"
                                    required
                                >
                            </div>
                        </div>

                        <div class="form-group mb-4" x-data="{ focused: false, showPassword: false }">
                            <label class="form-label" for="password">Password</label>
                            <div class="input-with-icon">
                                <svg class="icon input-icon" :class="{ 'focused': focused }"><use href="./assets/icons/tabler-sprites.svg#security-password-field"></use></svg>
                                <input
                                    :type="showPassword ? 'text' : 'password'"
                                    id="password"
                                    x-model="credentials.password"
                                    @focus="focused = true"
                                    @blur="focused = false"
                                    class="form-input"
                                    style="padding-left: 2.5rem; padding-right: 2.5rem;"
                                    placeholder="••••••••"
                                    autocomplete="current-password"
                                    required
                                >
                                <button type="button" @click="showPassword = !showPassword" class="password-toggle" tabindex="-1">
                                    <svg class="icon"><use :href="showPassword ? './assets/icons/tabler-sprites.svg#password-hide' : './assets/icons/tabler-sprites.svg#password-show'"></use></svg>
                                </button>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-full" :disabled="loading">
                            <span x-show="!loading">Sign In</span>
                            <span x-show="loading" class="flex items-center justify-center">
                                <blob-spinner class="mr-2"></blob-spinner>
                                Signing in...
                            </span>
                        </button>
                    </form>

                    <!-- MFA Form (shown after initial login if MFA enabled) -->
                    <div x-show="showMFA" x-transition x-cloak>
                        <!-- Header -->
                        <div class="text-center mb-6">
                            <div class="icon-badge-sm bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="icon icon-lg text-primary-600"><use href="./assets/icons/tabler-sprites.svg#security-mfa"></use></svg>
                            </div>
                            <h2 class="text-lg font-bold text-neutral-900">Two-Factor Authentication</h2>
                            <p class="text-sm text-neutral-500 mt-1">Enter the code from your authenticator app</p>
                        </div>

                        <form @submit.prevent="completeMFA" class="space-y-4">
                            <div class="form-group">
                                <input
                                    type="text"
                                    id="mfa-code"
                                    x-model="mfaCode"
                                    @input="if (mfaCode.length === 6) completeMFA()"
                                    class="form-input text-center text-2xl tracking-widest font-mono"
                                    placeholder="000000"
                                    maxlength="6"
                                    pattern="[0-9]{6}"
                                    inputmode="numeric"
                                    autocomplete="one-time-code"
                                    required
                                >
                            </div>

                            <!-- Keep Signed In Checkbox -->
                            <div class="btn-checkbox-group">
                                <button type="button"
                                    @click="keepSignedIn = !keepSignedIn"
                                    class="btn-checkbox w-full"
                                    :class="{ 'active': keepSignedIn }">
                                    <svg class="icon mr-2"><use :href="keepSignedIn ? './assets/icons/tabler-sprites.svg#checkbox-checked' : './assets/icons/tabler-sprites.svg#checkbox-unchecked'"></use></svg>
                                    Keep me signed in
                                </button>
                            </div>

                            <button type="submit" class="btn btn-primary w-full" :disabled="loading">
                                <span x-show="!loading">Verify</span>
                                <span x-show="loading" class="flex items-center justify-center">
                                    <blob-spinner class="mr-2"></blob-spinner>
                                    Verifying...
                                </span>
                            </button>
                        </form>
                    </div>

                    <!-- Set New Password Form (first-time users with temporary password) -->
                    <div x-show="newPasswordRequired" x-transition x-cloak>
                        <div class="text-center mb-4">
                            <div class="icon-badge-sm bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                <svg class="icon icon-lg text-primary-600"><use href="./assets/icons/tabler-sprites.svg#security-set-password"></use></svg>
                            </div>
                            <h2 class="text-lg font-bold text-neutral-900">Set Your Password</h2>
                            <p class="text-sm text-neutral-500 mt-1">Please create a new password for your account</p>
                        </div>

                        <!-- Error Message -->
                        <div x-show="newPasswordError" x-transition class="alert-error mb-4">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                            <span x-text="newPasswordError"></span>
                        </div>

                        <form @submit.prevent="submitNewPassword" class="space-y-4">
                            <div class="form-group mb-4" x-data="{ showPassword: false }">
                                <label class="form-label" for="new-password">New Password</label>
                                <div class="input-with-icon">
                                    <svg class="icon input-icon"><use href="./assets/icons/tabler-sprites.svg#security-password-field"></use></svg>
                                    <input
                                        :type="showPassword ? 'text' : 'password'"
                                        id="new-password"
                                        x-model="newPasswordData.password"
                                        class="form-input"
                                        style="padding-left: 2.5rem; padding-right: 2.5rem;"
                                        placeholder="••••••••••••"
                                        autocomplete="new-password"
                                        required
                                    >
                                    <button type="button" @click="showPassword = !showPassword" class="password-toggle" tabindex="-1">
                                        <svg class="icon"><use :href="showPassword ? './assets/icons/tabler-sprites.svg#password-hide' : './assets/icons/tabler-sprites.svg#password-show'"></use></svg>
                                    </button>
                                </div>
                            </div>

                            <div class="form-group mb-4" x-data="{ showPassword: false }">
                                <label class="form-label" for="confirm-password">Confirm Password</label>
                                <div class="input-with-icon">
                                    <svg class="icon input-icon"><use href="./assets/icons/tabler-sprites.svg#security-password-field"></use></svg>
                                    <input
                                        :type="showPassword ? 'text' : 'password'"
                                        id="confirm-password"
                                        autocomplete="new-password"
                                        x-model="newPasswordData.confirmPassword"
                                        class="form-input"
                                        style="padding-left: 2.5rem; padding-right: 2.5rem;"
                                        placeholder="••••••••••••"
                                        required
                                    >
                                    <button type="button" @click="showPassword = !showPassword" class="password-toggle" tabindex="-1">
                                        <svg class="icon"><use :href="showPassword ? './assets/icons/tabler-sprites.svg#password-hide' : './assets/icons/tabler-sprites.svg#password-show'"></use></svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Dynamic Password Requirements -->
                            <div class="text-xs space-y-1">
                                <p class="font-medium text-neutral-700">Password requirements:</p>
                                <ul class="space-y-0.5">
                                    <li :class="hasMinLength ? 'text-success-700' : 'text-neutral-500'">
                                        <svg class="icon icon-xs mr-1" :class="hasMinLength ? 'text-success-600' : 'text-neutral-300'"><use :href="hasMinLength ? './assets/icons/tabler-sprites.svg#validation-met' : './assets/icons/tabler-sprites.svg#error'"></use></svg>
                                        At least 12 characters
                                    </li>
                                    <li :class="hasUpperAndLower ? 'text-success-700' : 'text-neutral-500'">
                                        <svg class="icon icon-xs mr-1" :class="hasUpperAndLower ? 'text-success-600' : 'text-neutral-300'"><use :href="hasUpperAndLower ? './assets/icons/tabler-sprites.svg#validation-met' : './assets/icons/tabler-sprites.svg#error'"></use></svg>
                                        Uppercase and lowercase letters
                                    </li>
                                    <li :class="hasNumber ? 'text-success-700' : 'text-neutral-500'">
                                        <svg class="icon icon-xs mr-1" :class="hasNumber ? 'text-success-600' : 'text-neutral-300'"><use :href="hasNumber ? './assets/icons/tabler-sprites.svg#validation-met' : './assets/icons/tabler-sprites.svg#error'"></use></svg>
                                        At least one number
                                    </li>
                                    <li :class="hasSpecialChar ? 'text-success-700' : 'text-neutral-500'">
                                        <svg class="icon icon-xs mr-1" :class="hasSpecialChar ? 'text-success-600' : 'text-neutral-300'"><use :href="hasSpecialChar ? './assets/icons/tabler-sprites.svg#validation-met' : './assets/icons/tabler-sprites.svg#error'"></use></svg>
                                        At least one special character
                                    </li>
                                    <li :class="passwordsMatch ? 'text-success-700' : 'text-neutral-500'">
                                        <svg class="icon icon-xs mr-1" :class="passwordsMatch ? 'text-success-600' : 'text-neutral-300'"><use :href="passwordsMatch ? './assets/icons/tabler-sprites.svg#validation-met' : './assets/icons/tabler-sprites.svg#error'"></use></svg>
                                        Passwords match
                                    </li>
                                </ul>
                            </div>

                            <button type="submit" class="btn btn-primary w-full" :disabled="newPasswordLoading">
                                <span x-show="!newPasswordLoading" class="flex items-center justify-center">
                                    <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#action-verify"></use></svg>
                                    Set Password
                                </span>
                                <span x-show="newPasswordLoading" class="flex items-center justify-center">
                                    <blob-spinner class="mr-2"></blob-spinner>
                                    Setting password...
                                </span>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Trust Signals Footer -->
                <div x-show="!showMFA && !newPasswordRequired && !mfaSetupRequired" class="text-center mt-6">
                    <div class="trust-signals">
                        <span>
                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#security-lock"></use></svg>
                            256-bit Encryption
                        </span>
                        <span>
                            <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#badge-cloud"></use></svg>
                            Secure Cloud
                        </span>
                    </div>
                </div>

                <!-- Copyright -->
                <div x-show="!showMFA && !newPasswordRequired && !mfaSetupRequired" class="text-center mt-4">
                    <p class="text-xs text-neutral-400">&copy; 2025 Jake Vincent. All rights reserved.</p>
                </div>
            </div>
        </div>

        <!-- ========================================
             MFA SETUP MODAL
             ======================================== -->
        <div x-cloak
            x-show="mfaSetupRequired"
            x-transition
            class="modal-overlay">
            <div class="card auth-card w-full max-w-md"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100">

                <!-- Step 0: Download App -->
                <div x-show="mfaSetupStep === 'download'">
                    <div class="text-center mb-6">
                        <div class="icon-badge-md bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="icon icon-xl text-primary-600"><use href="./assets/icons/tabler-sprites.svg#security-device-mobile"></use></svg>
                        </div>
                        <h2 class="text-xl font-bold text-neutral-900">Secure Your Clinical Account</h2>
                        <p class="text-sm text-neutral-500 mt-2">You'll need an authenticator app on your phone</p>
                    </div>

                    <!-- HIPAA Context -->
                    <div class="alert-info text-sm mb-6">
                        <svg class="icon mr-2 flex-shrink-0"><use href="./assets/icons/tabler-sprites.svg#info"></use></svg>
                        <span>Two-factor authentication is required to protect patient information and meet HIPAA security requirements.</span>
                    </div>

                    <!-- App Instructions -->
                    <div class="space-y-4 mb-6">
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-neutral-100 rounded-lg flex items-center justify-center">
                                <svg class="icon text-neutral-700"><use href="./assets/icons/tabler-sprites.svg#platform-ios"></use></svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-neutral-900">iPhone</p>
                                <p class="text-xs text-neutral-500">Download Microsoft Authenticator or Google Authenticator from the App Store</p>
                            </div>
                        </div>
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-neutral-100 rounded-lg flex items-center justify-center">
                                <svg class="icon text-neutral-700"><use href="./assets/icons/tabler-sprites.svg#platform-android"></use></svg>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-neutral-900">Android</p>
                                <p class="text-xs text-neutral-500">Download Google Authenticator from the Play Store</p>
                            </div>
                        </div>
                    </div>

                    <button @click="advanceToQRStep()" class="btn btn-primary w-full">
                        <span class="flex items-center justify-center">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#continue"></use></svg>
                            I've Installed the App
                        </span>
                    </button>
                </div>

                <!-- Step 1: QR Code -->
                <div x-show="mfaSetupStep === 'qr'">
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold text-neutral-900">Secure Your Clinical Account</h2>
                        <p class="text-sm text-neutral-500 mt-2">Scan this QR code with your authenticator app</p>
                    </div>

                    <!-- Loading State -->
                    <div x-show="mfaSetupLoading" class="text-center py-8">
                        <blob-spinner class="icon-lg text-primary-500 mx-auto"></blob-spinner>
                        <p class="text-sm text-neutral-500 mt-2">Loading...</p>
                    </div>

                    <!-- QR Code Display -->
                    <div x-show="!mfaSetupLoading && mfaSetupData.qrCodeUrl" class="mb-6">
                        <!-- Cross-device instruction -->
                        <div class="bg-primary-50 border border-primary-100 rounded-lg p-3 mb-4">
                            <p class="text-xs text-primary-800 text-center">
                                <svg class="icon icon-sm mr-1"><use href="./assets/icons/tabler-sprites.svg#security-device-mobile"></use></svg>
                                Open your authenticator app on your phone and scan this code
                            </p>
                        </div>

                        <div class="bg-neutral-50 p-4 rounded-lg text-center mb-4">
                            <div x-ref="qrcodeContainer"
                                 x-effect="generateQRCode($refs.qrcodeContainer, mfaSetupData.qrCodeUrl)"
                                 class="mx-auto mb-3 flex justify-center"></div>
                            <p class="text-xs text-neutral-500 mb-2">Or enter this code manually:</p>
                            <div class="manual-code-container">
                                <code class="text-sm font-mono bg-neutral-100 px-3 py-2 rounded"
                                      x-text="formatSecretCode(mfaSetupData.secretCode)"></code>
                                <button
                                    @click="copySecretCode()"
                                    class="manual-code-copy-btn text-neutral-500 hover:text-primary-600 transition-colors"
                                    :title="secretCodeCopied ? 'Copied!' : 'Copy to clipboard'"
                                >
                                    <svg class="icon" :class="secretCodeCopied ? 'text-success-600' : ''"><use :href="secretCodeCopied ? './assets/icons/tabler-sprites.svg#copy-success' : './assets/icons/tabler-sprites.svg#action-copy'"></use></svg>
                                </button>
                            </div>
                            <p x-show="secretCodeCopied" x-transition class="text-xs text-success-600 mt-2">
                                Copied to clipboard!
                            </p>
                        </div>

                        <button @click="mfaSetupStep = 'verify'" class="btn btn-primary w-full">
                            <span class="flex items-center justify-center">
                                <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#continue"></use></svg>
                                Continue
                            </span>
                        </button>
                    </div>

                    <!-- Error State -->
                    <div x-show="mfaSetupError" class="alert-error mb-4">
                        <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                        <span x-text="mfaSetupError"></span>
                    </div>

                    <button @click="mfaSetupStep = 'download'" class="btn btn-ghost w-full mt-2">
                        <span class="flex items-center justify-center">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#back"></use></svg>
                            Back
                        </span>
                    </button>
                </div>

                <!-- Step 2: Verify Code -->
                <div x-show="mfaSetupStep === 'verify'">
                    <div class="text-center mb-6">
                        <h2 class="text-xl font-bold text-neutral-900">Verify Your Setup</h2>
                        <p class="text-sm text-neutral-500 mt-2">Enter the 6-digit code from your authenticator app</p>
                    </div>

                    <form @submit.prevent="verifyMFASetup">
                        <div class="form-group mb-4">
                            <input type="text"
                                   x-model="mfaSetupData.verificationCode"
                                   @input="if (mfaSetupData.verificationCode.length === 6) verifyMFASetup()"
                                   class="form-input text-center text-2xl tracking-widest font-mono"
                                   placeholder="000000"
                                   maxlength="6"
                                   pattern="[0-9]{6}"
                                   inputmode="numeric"
                                   autocomplete="one-time-code"
                                   required>
                        </div>

                        <!-- Error State -->
                        <div x-show="mfaSetupError" class="alert-error mb-4">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                            <span x-text="mfaSetupError"></span>
                        </div>

                        <button type="submit" class="btn btn-primary w-full" :disabled="mfaSetupLoading">
                            <span x-show="!mfaSetupLoading" class="flex items-center justify-center">
                                <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#action-verify"></use></svg>
                                Verify
                            </span>
                            <span x-show="mfaSetupLoading" class="flex items-center justify-center">
                                <blob-spinner class="mr-2"></blob-spinner>
                                Verifying...
                            </span>
                        </button>
                    </form>

                    <button @click="mfaSetupStep = 'qr'" class="btn btn-ghost w-full mt-2">
                        <span class="flex items-center justify-center">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#back"></use></svg>
                            Back to QR Code
                        </span>
                    </button>
                </div>

                <!-- Step 3: Success -->
                <div x-show="mfaSetupStep === 'complete'">
                    <div class="text-center mb-6">
                        <div class="icon-badge-md bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="icon icon-xl text-success-600"><use href="./assets/icons/tabler-sprites.svg#complete"></use></svg>
                        </div>
                        <h2 class="text-xl font-bold text-neutral-900">You're All Set!</h2>
                        <p class="text-sm text-neutral-500 mt-2">Your account is now protected with two-factor authentication</p>
                    </div>

                    <!-- Security badge -->
                    <div class="bg-success-50 border border-success-100 rounded-lg p-4 mb-6">
                        <div class="flex items-center gap-2 mb-2">
                            <svg class="icon text-success-600"><use href="./assets/icons/tabler-sprites.svg#success"></use></svg>
                            <span class="font-medium text-success-800">Account Secured</span>
                        </div>
                        <p class="text-sm text-success-700">Your clinical data is now protected with an additional layer of security.</p>
                    </div>

                    <!-- What happens next -->
                    <div class="mb-6">
                        <p class="text-sm font-medium text-neutral-700 mb-3">What happens next time you sign in:</p>
                        <ol class="space-y-2 text-sm text-neutral-600">
                            <li class="flex items-start gap-2">
                                <span class="flex-shrink-0 w-5 h-5 bg-primary-100 rounded-full flex items-center justify-center text-xs font-medium text-primary-700">1</span>
                                <span>Enter your email and password</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="flex-shrink-0 w-5 h-5 bg-primary-100 rounded-full flex items-center justify-center text-xs font-medium text-primary-700">2</span>
                                <span>Open your authenticator app</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="flex-shrink-0 w-5 h-5 bg-primary-100 rounded-full flex items-center justify-center text-xs font-medium text-primary-700">3</span>
                                <span>Enter the 6-digit code shown in the app</span>
                            </li>
                        </ol>
                    </div>

                    <!-- Recovery FAQ -->
                    <details class="mb-6 text-sm">
                        <summary class="flex items-center justify-between cursor-pointer text-neutral-600 hover:text-neutral-900">
                            <span>What if I lose access to my authenticator?</span>
                            <svg class="icon icon-xs chevron"><use href="./assets/icons/tabler-sprites.svg#expand"></use></svg>
                        </summary>
                        <div class="mt-3 pl-0 text-neutral-500">
                            <p class="mb-2">Contact your administrator to reset your two-factor authentication. You'll need to set it up again with a new QR code.</p>
                            <ul class="pl-6 space-y-1" style="list-style-type: disc;">
                                <li>Keep your phone secure and backed up</li>
                                <li>Consider setting up the authenticator on a second device</li>
                            </ul>
                        </div>
                    </details>

                    <button @click="completeMFASetup" class="btn btn-primary w-full">
                        <span class="flex items-center justify-center">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#continue"></use></svg>
                            Continue to App
                        </span>
                    </button>
                </div>
            </div>
        </div>

    </div>
</body>
</html>
