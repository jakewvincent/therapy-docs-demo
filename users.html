<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Therapy Docs</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Critical CSS to prevent FOUC -->
    <style>[x-cloak] { display: none !important; }</style>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="dist/output.css">

    <!-- Application Entry Point (ES Module) - includes Alpine.js -->
    <script type="module" src="js/entries/users.entry.js"></script>
</head>
<body>
    <div x-data="usersApp" class="min-h-screen bg-neutral-50" :class="{ 'mock-watermark': window.config?.useMockAPI }">

        <!-- Shared Navigation Drawer -->
        <div id="nav-drawer"></div>

        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-neutral-200 sticky top-0 z-40">
            <div class="px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button @click="drawerOpen = true" class="hamburger-btn">
                        <svg class="icon"><use href="./assets/icons/tabler-sprites.svg#menu-hamburger"></use></svg>
                    </button>
                    <h1 class="text-lg font-bold text-neutral-900 flex items-center">
                        <svg class="icon mr-2 text-primary-500"><use href="./assets/icons/tabler-sprites.svg#admin-users"></use></svg>
                        User Management
                    </h1>
                </div>
                <button
                    @click="openInviteModal"
                    class="btn btn-primary"
                >
                    <span class="flex items-center">
                        <svg class="icon icon-md mr-2"><use href="./assets/icons/tabler-sprites.svg#action-invite-user"></use></svg>
                        Invite User
                    </span>
                </button>
            </div>
        </header>

        <!-- Loading State -->
        <template x-if="loading">
            <div class="p-8 text-center">
                <blob-spinner class="icon-lg text-primary-500 mx-auto"></blob-spinner>
                <p class="text-neutral-500 mt-2">Loading users...</p>
            </div>
        </template>

        <!-- Main Content -->
        <main x-show="!loading" x-cloak class="container-narrow section">
            <div class="space-y-6">

                <!-- Users List -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-lg font-semibold text-neutral-900">
                            <svg class="icon mr-2 text-primary-500 inline-block"><use href="./assets/icons/tabler-sprites.svg#users"></use></svg>
                            Users
                            <span class="text-sm font-normal text-neutral-500" x-text="'(' + users.length + ')'"></span>
                        </h2>
                    </div>
                    <div class="card-body p-0">
                        <!-- Empty State -->
                        <div x-show="users.length === 0" class="text-center py-8 text-neutral-500">
                            <svg class="icon icon-2xl mb-3 opacity-50 mx-auto"><use href="./assets/icons/tabler-sprites.svg#users"></use></svg>
                            <p>No users found.</p>
                        </div>

                        <!-- User List -->
                        <div class="divide-y divide-neutral-200">
                            <template x-for="user in users" :key="user.id">
                                <div class="p-4 hover:bg-neutral-50 transition-colors">
                                    <div class="flex items-center justify-between">
                                        <!-- User Info -->
                                        <div class="flex items-center gap-4">
                                            <div class="w-10 h-10 rounded-full bg-primary-100 flex items-center justify-center">
                                                <svg class="icon text-primary-600"><use href="./assets/icons/tabler-sprites.svg#user"></use></svg>
                                            </div>
                                            <div>
                                                <div class="flex items-center gap-2">
                                                    <span class="font-semibold text-neutral-900" x-text="user.name"></span>
                                                    <span
                                                        class="badge text-xs"
                                                        :class="getRoleBadgeClass(user.role)"
                                                        x-text="user.role"
                                                    ></span>
                                                    <span
                                                        x-show="user.id === currentUserId"
                                                        class="badge badge-neutral text-xs"
                                                    >You</span>
                                                </div>
                                                <p class="text-sm text-neutral-500" x-text="user.email"></p>
                                                <div class="flex items-center gap-3 mt-1 text-xs text-neutral-500">
                                                    <span class="flex items-center gap-1">
                                                        <svg class="icon icon-xs"><use href="./assets/icons/tabler-sprites.svg#date"></use></svg>
                                                        Joined <span x-text="formatDate(user.createdAt)"></span>
                                                    </span>
                                                    <span class="flex items-center gap-1">
                                                        <svg class="icon icon-sm" :class="user.mfaEnabled ? 'text-success-500' : 'text-warning-500'"><use :href="user.mfaEnabled ? './assets/icons/tabler-sprites.svg#security-mfa-enabled' : './assets/icons/tabler-sprites.svg#security-mfa-disabled'"></use></svg>
                                                        <span x-text="user.mfaEnabled ? 'MFA Enabled' : 'MFA Not Set Up'"></span>
                                                    </span>
                                                    <span
                                                        class="badge text-xs"
                                                        :class="getStatusBadgeClass(user.status)"
                                                        x-text="formatStatus(user.status)"
                                                    ></span>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Actions -->
                                        <div x-show="canEditUser(user)" class="flex items-center gap-2">
                                            <button
                                                @click="openEditRoleModal(user)"
                                                class="btn btn-ghost btn-sm"
                                                title="Change role"
                                            >
                                                <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-change-role"></use></svg>
                                            </button>
                                            <button
                                                x-show="user.mfaEnabled"
                                                @click="openResetMFAModal(user)"
                                                class="btn btn-ghost btn-sm"
                                                title="Reset MFA"
                                            >
                                                <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-security-mfa-reset"></use></svg>
                                            </button>
                                            <button
                                                x-show="canDeleteUser(user)"
                                                @click="openDeleteModal(user)"
                                                class="btn btn-ghost btn-sm text-danger-500 hover:text-danger-700"
                                                title="Remove user"
                                            >
                                                <svg class="icon icon-md"><use href="./assets/icons/tabler-sprites.svg#action-delete"></use></svg>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Role Permissions Info -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="text-lg font-semibold text-neutral-900">
                            <svg class="icon mr-2 text-primary-500 inline-block"><use href="./assets/icons/tabler-sprites.svg#info"></use></svg>
                            Role Permissions
                        </h2>
                    </div>
                    <div class="card-body">
                        <div class="space-y-4">
                            <div class="flex items-start gap-3">
                                <span class="badge badge-danger">sysadmin</span>
                                <p class="text-sm text-neutral-600">Full system access. Can manage all users including admins, configure system settings.</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="badge badge-primary">admin</span>
                                <p class="text-sm text-neutral-600">Can invite and manage supervisors, full app access, edit intervention lexicon.</p>
                            </div>
                            <div class="flex items-start gap-3">
                                <span class="badge badge-secondary">supervisor</span>
                                <p class="text-sm text-neutral-600">View-only access. Can view clients and session notes but cannot edit.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ========================================
             INVITE USER MODAL
             ======================================== -->
        <div x-cloak
            x-show="showInviteModal"
            x-transition
            class="modal-overlay"
            @click.self="closeInviteModal"
            @keydown.escape="closeInviteModal">
            <div class="card w-full max-w-md"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100">
                <div class="card-header">
                    <h2 class="text-xl font-bold text-neutral-900">
                        <svg class="icon mr-2 text-primary-500 inline-block"><use href="./assets/icons/tabler-sprites.svg#action-invite-user"></use></svg>
                        Invite User
                    </h2>
                </div>
                <div class="card-body">
                    <form @submit.prevent="inviteUser">
                        <div class="form-group mb-4">
                            <label class="form-label" for="invite-name">Name</label>
                            <input
                                type="text"
                                id="invite-name"
                                x-model="newUser.name"
                                class="form-input"
                                placeholder="Full name"
                                required
                            >
                        </div>

                        <div class="form-group mb-4">
                            <label class="form-label" for="invite-email">Email</label>
                            <input
                                type="email"
                                id="invite-email"
                                x-model="newUser.email"
                                class="form-input"
                                placeholder="user@example.com"
                                required
                            >
                        </div>

                        <div class="form-group mb-6">
                            <label class="form-label" for="invite-role">Role</label>
                            <select id="invite-role" x-model="newUser.role" class="form-select">
                                <option value="supervisor">Supervisor (View-only)</option>
                                <option value="admin" x-show="isSysAdmin()">Admin</option>
                            </select>
                            <p class="text-xs text-neutral-500 mt-1">
                                <template x-if="newUser.role === 'supervisor'">
                                    <span>Can view clients and session notes, but cannot edit.</span>
                                </template>
                                <template x-if="newUser.role === 'admin'">
                                    <span>Full access to all features and can manage supervisors.</span>
                                </template>
                            </p>
                        </div>

                        <div class="alert-info mb-4">
                            <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#security-email"></use></svg>
                            <span class="text-sm">An invitation email with a temporary password will be sent to this address.</span>
                        </div>

                        <div class="flex gap-3">
                            <button
                                type="button"
                                @click="closeInviteModal"
                                class="btn btn-secondary flex-1"
                                :disabled="inviting"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                class="btn btn-primary flex-1"
                                :disabled="inviting"
                            >
                                <span x-show="!inviting" class="flex items-center justify-center">
                                    <svg class="icon icon-sm mr-2"><use href="./assets/icons/tabler-sprites.svg#action-send"></use></svg>
                                    Send Invitation
                                </span>
                                <span x-show="inviting" class="flex items-center justify-center">
                                    <blob-spinner class="icon-sm mr-2"></blob-spinner>
                                    Sending...
                                </span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ========================================
             EDIT ROLE MODAL
             ======================================== -->
        <div x-cloak
            x-show="showEditRoleModal"
            x-transition
            class="modal-overlay"
            @click.self="closeEditRoleModal"
            @keydown.escape="closeEditRoleModal">
            <div class="card w-full max-w-md"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100">
                <div class="card-header">
                    <h2 class="text-xl font-bold text-neutral-900">
                        <svg class="icon mr-2 text-primary-500 inline-block"><use href="./assets/icons/tabler-sprites.svg#user-management"></use></svg>
                        Change Role
                    </h2>
                </div>
                <div class="card-body">
                    <p class="text-neutral-600 mb-4">
                        Update role for <strong x-text="editingUser?.name"></strong>
                    </p>

                    <div class="form-group mb-6">
                        <label class="form-label">New Role</label>
                        <div class="btn-radio-group">
                            <button
                                type="button"
                                class="btn-radio"
                                :class="{ 'checked': newRole === 'supervisor' }"
                                @click="newRole = 'supervisor'"
                            >
                                <svg class="icon icon-sm"><use :href="newRole === 'supervisor' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                Supervisor
                            </button>
                            <button
                                type="button"
                                class="btn-radio"
                                :class="{ 'checked': newRole === 'admin' }"
                                @click="newRole = 'admin'"
                                x-show="isSysAdmin()"
                            >
                                <svg class="icon icon-sm"><use :href="newRole === 'admin' ? './assets/icons/tabler-sprites.svg#radio-checked' : './assets/icons/tabler-sprites.svg#radio-unchecked'"></use></svg>
                                Admin
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button
                            type="button"
                            @click="closeEditRoleModal"
                            class="btn btn-secondary flex-1"
                            :disabled="actionLoading"
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            @click="updateRole"
                            class="btn btn-primary flex-1"
                            :disabled="actionLoading || newRole === editingUser?.role"
                        >
                            <span x-show="!actionLoading" class="flex items-center justify-center">
                                <svg class="icon icon-sm mr-2"><use href="./assets/icons/tabler-sprites.svg#selected"></use></svg>
                                Update Role
                            </span>
                            <span x-show="actionLoading" class="flex items-center justify-center">
                                <blob-spinner class="icon-sm mr-2"></blob-spinner>
                                Updating...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             DELETE CONFIRMATION MODAL
             ======================================== -->
        <div x-cloak
            x-show="showDeleteModal"
            x-transition
            class="modal-overlay"
            @click.self="closeDeleteModal"
            @keydown.escape="closeDeleteModal">
            <div class="card w-full max-w-md"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100">
                <div class="card-header">
                    <h2 class="text-xl font-bold text-danger-600">
                        <svg class="icon mr-2 inline-block"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                        Remove User
                    </h2>
                </div>
                <div class="card-body">
                    <div class="alert-warning mb-4">
                        <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                        <span>This action cannot be undone.</span>
                    </div>

                    <p class="text-neutral-600 mb-4">
                        Are you sure you want to remove <strong x-text="deletingUser?.name"></strong>
                        (<span x-text="deletingUser?.email"></span>)?
                    </p>

                    <p class="text-sm text-neutral-500 mb-6">
                        This user will no longer be able to access the application.
                    </p>

                    <div class="flex gap-3">
                        <button
                            type="button"
                            @click="closeDeleteModal"
                            class="btn btn-secondary flex-1"
                            :disabled="actionLoading"
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            @click="deleteUser"
                            class="btn btn-danger flex-1"
                            :disabled="actionLoading"
                        >
                            <span x-show="!actionLoading" class="flex items-center justify-center">
                                <svg class="icon icon-sm mr-2"><use href="./assets/icons/tabler-sprites.svg#action-delete"></use></svg>
                                Remove User
                            </span>
                            <span x-show="actionLoading" class="flex items-center justify-center">
                                <blob-spinner class="icon-sm mr-2"></blob-spinner>
                                Removing...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             RESET MFA CONFIRMATION MODAL
             ======================================== -->
        <div x-cloak
            x-show="showResetMFAModal"
            x-transition
            class="modal-overlay"
            @click.self="closeResetMFAModal"
            @keydown.escape="closeResetMFAModal">
            <div class="card w-full max-w-md"
                x-transition:enter="transition ease-out duration-200"
                x-transition:enter-start="opacity-0 scale-95"
                x-transition:enter-end="opacity-100 scale-100">
                <div class="card-header">
                    <h2 class="text-xl font-bold text-neutral-900">
                        <svg class="icon mr-2 text-warning-500 inline-block"><use href="./assets/icons/tabler-sprites.svg#security-mfa"></use></svg>
                        Reset MFA
                    </h2>
                </div>
                <div class="card-body">
                    <p class="text-neutral-600 mb-4">
                        Reset two-factor authentication for <strong x-text="resettingMFAUser?.name"></strong>?
                    </p>

                    <div class="alert-info mb-6">
                        <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#info"></use></svg>
                        <span class="text-sm">The user will need to set up MFA again on their next login.</span>
                    </div>

                    <div class="flex gap-3">
                        <button
                            type="button"
                            @click="closeResetMFAModal"
                            class="btn btn-secondary flex-1"
                            :disabled="actionLoading"
                        >
                            Cancel
                        </button>
                        <button
                            type="button"
                            @click="resetMFA"
                            class="btn btn-primary flex-1"
                            :disabled="actionLoading"
                        >
                            <span x-show="!actionLoading" class="flex items-center justify-center">
                                <svg class="icon icon-sm mr-2"><use href="./assets/icons/tabler-sprites.svg#security-mfa"></use></svg>
                                Reset MFA
                            </span>
                            <span x-show="actionLoading" class="flex items-center justify-center">
                                <blob-spinner class="icon-sm mr-2"></blob-spinner>
                                Resetting...
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ========================================
             TOAST NOTIFICATIONS
             ======================================== -->
        <div class="fixed bottom-4 right-4 space-y-2 z-50">
            <!-- Success Toast -->
            <div
                x-show="showSuccessToast"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 translate-y-2"
                x-cloak
                class="alert-success shadow-lg min-w-[300px]"
            >
                <div class="flex items-center">
                    <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#success"></use></svg>
                    <span x-text="successMessage"></span>
                </div>
            </div>

            <!-- Error Toast -->
            <div
                x-show="showErrorToast"
                x-transition:enter="transition ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-2"
                x-transition:enter-end="opacity-100 translate-y-0"
                x-transition:leave="transition ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0"
                x-transition:leave-end="opacity-0 translate-y-2"
                x-cloak
                class="alert-error shadow-lg min-w-[300px]"
            >
                <div class="flex items-center">
                    <svg class="icon mr-2"><use href="./assets/icons/tabler-sprites.svg#warning"></use></svg>
                    <span x-text="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
